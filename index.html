<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>SegnalaFacile</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    :root{
      --bg:#0b1220;
      --bg2:#070c18;
      --text:#eaf0ff;
      --muted:#a9b6db;

      --accent:#2d7dff;
      --accent2:#19c37d;
      --danger:#ff4d4f;

      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.16);

      --r:22px;
      --r2:28px;

      --shadow: 0 18px 45px rgba(0,0,0,.40);
      --shadow2: 0 10px 25px rgba(0,0,0,.35);

      --glass1: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.04);

      --tabbar-h: 74px;
      --tabbar-radius: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(45,125,255,.28), transparent 55%),
        radial-gradient(1100px 700px at 85% 5%, rgba(25,195,125,.20), transparent 60%),
        radial-gradient(900px 650px at 50% 120%, rgba(45,125,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    /* spazio sicuro per la tabbar premium */
    body{
      padding-bottom: calc(var(--tabbar-h) + 34px);
    }

    .wrap{
      max-width: 920px;
      margin: 0 auto;
      padding: 18px 16px 40px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 0 12px;
    }

    .brand{display:flex; align-items:center; gap:14px;}
    .logo{
      width:70px; height:70px; border-radius:22px;
      background:
        url("icons/icon-192.png") center/cover no-repeat,
        linear-gradient(135deg, rgba(45,125,255,.95), rgba(25,195,125,.90));
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      outline: 1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .title{
      font-size: 28px;
      font-weight: 980;
      letter-spacing: -.35px;
      line-height: 1.05;
    }

    .grid{display:grid; gap:14px}

    .card{
      position: relative;
      background: linear-gradient(145deg, rgba(38,86,108,.85), rgba(12,25,45,.85));
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 28px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      margin-bottom: 28px;
      min-height: 60vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-1px;
      background: radial-gradient(740px 160px at 20% 0%, rgba(45,125,255,.22), transparent 55%),
                  radial-gradient(740px 160px at 85% 0%, rgba(25,195,125,.18), transparent 55%);
      pointer-events:none;
      opacity:.95;
      border-radius: 28px;
    }
    .card > *{position:relative}

    /* HERO pi√π impattante */
    .heroTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    /* HERO COVER */
    .heroCover{
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 45px rgba(0,0,0,.38);
      display: block;
      margin: 14px 0 16px;
      filter: saturate(1.05) contrast(1.02);
    }
    @media (min-width: 520px){
      .heroCover{ height: 210px; }
    }

    .hero h1{
      margin:0 0 10px;
      font-size: 34px;
      line-height: 1.08;
      letter-spacing: -.7px;
    }
    .hero p{
      margin:0;
      color: var(--muted);
      font-size: 15px;
      line-height: 1.55;
      max-width: 62ch;
    }

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}

    button, .btn{
      cursor:pointer;
      border:0;
      border-radius: 18px;
      padding: 12px 14px;
      font-weight: 900;
      font-size: 14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      text-decoration:none;
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      transition: transform .12s ease, filter .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      min-height: 46px;
    }
    button:active, .btn:active{transform: translateY(1px) scale(.99)}
    button:disabled{opacity:.65; cursor:not-allowed; transform:none !important}

    .primary{
      background: linear-gradient(135deg, rgba(45,125,255,1), rgba(45,125,255,.70));
      box-shadow: 0 18px 36px rgba(45,125,255,.18);
    }
    .primary:hover{filter: brightness(1.06)}
    .ghost{
      background: rgba(255,255,255,.055);
      border:1px solid var(--stroke);
    }
    .ghost:hover{border-color: var(--stroke2)}
    .danger{
      background: rgba(255,77,79,.14);
      border:1px solid rgba(255,77,79,.35);
    }
    .danger:hover{border-color: rgba(255,77,79,.55)}
    .small{padding:10px 12px; border-radius:16px; font-size:13px; min-height:42px}

    /* pulsante hero gigante */
    .ctaBig{
      width:100%;
      padding: 16px 16px;
      border-radius: 22px;
      font-size: 16px;
      font-weight: 980;
      min-height: 56px;
      background: linear-gradient(135deg, rgba(45,125,255,1), rgba(45,125,255,.62));
      box-shadow: 0 22px 44px rgba(45,125,255,.20);
    }
    .ctaBig .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(255,255,255,.9);
      box-shadow: 0 0 0 6px rgba(255,255,255,.12);
    }
    .ctaBig:hover{filter: brightness(1.06)}

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row > *{flex:1 1 220px}

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 12px 0 7px;
      font-weight: 850;
      letter-spacing: .25px;
    }

    input[type="text"], input[type="email"], input[type="tel"], textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    input:focus, textarea:focus{
      border-color: rgba(45,125,255,.55);
      box-shadow: 0 0 0 3px rgba(45,125,255,.16);
    }
    textarea{min-height:120px; resize:vertical}

    .hint{
      font-size:12.5px;
      color: var(--muted);
      margin-top:10px;
      line-height:1.5;
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      border-radius: 20px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      margin-top: 12px;
    }
    .toggle span{color:var(--muted); font-size:13px}
    .toggle strong{font-size:13px; font-weight:980}
    .toggle input{transform: scale(1.15)}

    .contactBox{
      margin-top: 12px;
      padding: 12px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
    }
    .contactTitle{
      font-weight: 980;
      letter-spacing: .2px;
      margin: 0 0 6px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .contactGrid{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    @media (max-width: 640px){
      .contactGrid{grid-template-columns: 1fr;}
    }

    .preview{
      margin-top: 12px;
      display:none;
      gap: 12px;
      align-items:flex-start;
      padding: 12px;
      border-radius: 22px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.16);
    }

    .thumbs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-start;
      padding:2px;
    }
    .thumbs img{
      width:76px;
      height:76px;
      object-fit:cover;
      border-radius:18px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      box-shadow: 0 10px 18px rgba(0,0,0,.30);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      color: var(--text);
      font-size: 12px;
      font-weight: 900;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }

    .list{display:grid; gap:10px; margin-top:12px}
    .item{
      padding: 12px;
      border-radius: 22px;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--stroke);
      display:flex;
      gap:12px;
      align-items:flex-start;
      transition: border-color .12s ease, transform .12s ease;
    }
    .item:hover{border-color: var(--stroke2)}
    .thumb{
      width: 78px; height: 78px;
      border-radius: 22px;
      border: 1px solid var(--stroke);
      object-fit: cover;
      background: rgba(255,255,255,.05);
      box-shadow: 0 10px 18px rgba(0,0,0,.28);
    }
    .item h3{margin:0; font-size:14px; font-weight:950}
    .item p{margin:6px 0 0; color:var(--muted); font-size:12.5px; line-height:1.45}
    .metaRow{margin-top:8px; display:flex; flex-wrap:wrap; gap:8px}

    .hidden{display:none !important}
    section{display:none}
    section:not(.hidden){display:block}

    .ok{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 14px;
      border-radius: 22px;
      border: 1px solid rgba(25,195,125,.35);
      background: rgba(25,195,125,.12);
    }

    .banner{
      position: sticky;
      top: 10px;
      z-index: 2000;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      border-radius: 22px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      margin: 0 0 12px;
    }
    .banner .text{font-size:13px; line-height:1.35; color:var(--text)}
    .banner .close{
      flex:0 0 auto;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color: var(--text);
      border-radius: 16px;
      padding: 8px 10px;
      font-weight: 950;
    }
    .banner.info{border-color: rgba(45,125,255,.35); background: rgba(45,125,255,.10)}
    .banner.success{border-color: rgba(25,195,125,.35); background: rgba(25,195,125,.12)}
    .banner.error{border-color: rgba(255,77,79,.35); background: rgba(255,77,79,.12)}

    /* PROGRESS INVIO */
    .progressWrap{
      margin-top: 12px;
      padding: 12px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      display:none;
    }
    .progressTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
    }
    .progressTitle{
      font-weight: 980;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .stepPill{
      font-size: 12px;
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      white-space: nowrap;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }
    .bar > span{
      display:block;
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(45,125,255,1), rgba(25,195,125,1));
      transition: width .25s ease;
    }
    .progressHint{
      margin-top: 10px;
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.45;
    }

    /* Empty state EXACT */
    .emptyState{
      text-align:center;
      opacity:.85;
      margin-top:40px;
    }
    .emptyIcon{
      font-size:48px;
      margin-bottom:10px;
    }

    /* ===== Premium Bottom Tab Bar (Glass) ===== */
    .tabbar{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      height: var(--tabbar-h);
      padding: 10px 12px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      align-items: center;
      z-index: 9999;

      background: rgba(18, 28, 40, .55);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--tabbar-radius);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .tab{
      position: relative;
      height: 100%;
      border: 0;
      background: transparent;
      color: rgba(255,255,255,.78);
      border-radius: 18px;
      display: grid;
      place-items: center;
      gap: 3px;
      cursor: pointer;
      transition: transform .12s ease, color .2s ease, background .2s ease, border-color .2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .tab:active{ transform: scale(.985); }

    .tab .ico{
      font-size: 26px;
      line-height: 1;
      display: inline-block;
      transform-origin: 50% 60%;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.25));
    }
    .tab .lbl{
      font-size: 12px;
      letter-spacing: .2px;
      opacity: .85;
      font-weight: 900;
    }

    .tab.is-active{
      color: #fff;
      background: linear-gradient(180deg, rgba(52,132,255,.28), rgba(52,132,255,.10));
      border: 1px solid rgba(90,160,255,.22);
    }
    .tab.is-active .lbl{ opacity: 1; }

    .tab-indicator{
      position: absolute;
      bottom: 8px;
      left: 12px; /* allineamento interno */
      width: calc((100% - 24px - 24px) / 4);
      height: 4px;
      border-radius: 999px;
      background: rgba(120,190,255,.95);
      box-shadow: 0 6px 16px rgba(80,170,255,.35);
      transform: translateX(0);
      transition: transform .25s cubic-bezier(.2,.9,.2,1);
      pointer-events: none;
    }

    @keyframes popWiggle {
      0%   { transform: scale(1) rotate(0deg); }
      35%  { transform: scale(1.18) rotate(-6deg); }
      70%  { transform: scale(1.10) rotate(5deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    .tab.is-active .ico{
      animation: popWiggle .38s ease;
    }

    /* micro-testo sopra la tabbar (non dentro la barra) */
    .tabbarNoteWrap{
      position: fixed;
      left: 0;
      right: 0;
      bottom: calc(var(--tabbar-h) + 18px);
      z-index: 9998;
      pointer-events: none;
    }
    .tabbarNote{
      max-width: 920px;
      margin: 0 auto;
      padding: 0 16px;
      color: rgba(234,240,255,.70);
      font-size: 13px;
      letter-spacing: .2px;
      text-shadow: 0 8px 18px rgba(0,0,0,.35);
    }

    @media (prefers-reduced-motion: no-preference){
      .card{animation: pop .18s ease both}
      @keyframes pop{
        from{transform: translateY(8px); opacity:0}
        to{transform: translateY(0); opacity:1}
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">SegnalaFacile</div>
        </div>
      </div>
      <button class="pill" id="installPill" style="display:none; cursor:pointer;" type="button">‚¨áÔ∏è Installa</button>
    </header>

    <div id="banner" class="banner hidden" role="status" aria-live="polite">
      <div class="text" id="bannerText"></div>
      <button class="close" id="bannerClose" type="button">‚úï</button>
    </div>

    <!-- HOME -->
    <section id="view-home" class="grid">
      <div class="card hero">
        <div class="heroTop">
          <div>
            <h1>Segnala subito.</h1>
            <p>Descrivi cosa succede, aggiungi le foto e invia. Il tuo storico resta sul dispositivo.</p>
          </div>
          <img class="heroCover" src="icons/hero.jpg" alt="Voci di Cassino" loading="lazy">
        </div>

        <div class="btnRow">
          <a class="btn ctaBig" href="#/report"><span class="dot"></span> Invia segnalazione</a>
        </div>

        <div class="btnRow">
          <a class="btn ghost" href="#/my">üóÇÔ∏è Le mie segnalazioni</a>
          <a class="btn ghost" href="#/contacts">‚òéÔ∏è Contatti</a>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
          <div>
            <div style="font-weight:980;margin-bottom:4px">Come funziona</div>
            <div class="hint" style="margin:0">Compili ‚Ä¢ Aggiungi foto ‚Ä¢ Invi ‚Ä¢ Ti resta lo storico</div>
          </div>
          <a class="btn small ghost" href="#/report">Vai ‚Üí</a>
        </div>
      </div>
    </section>

    <!-- REPORT -->
    <section id="view-report" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:980;font-size:18px">Nuova segnalazione</div>
            <div class="hint" style="margin:6px 0 0">Compila i campi e premi ‚ÄúInvia‚Äù.</div>
          </div>
          <a class="btn small ghost" href="#/">‚Üê Home</a>
        </div>

        <label for="titolo">Titolo</label>
        <input id="titolo" type="text" maxlength="80" placeholder="Es. Lampione spento in via‚Ä¶" />

        <label for="descrizione">Descrizione</label>
        <textarea id="descrizione" maxlength="700" placeholder="Spiega cosa succede, dove e quando‚Ä¶"></textarea>

        <label>Foto (opzionale)</label>
        <div class="row">
          <button class="ghost" id="btnPickCamera" type="button">üì∑ Scatta foto</button>
          <button class="ghost" id="btnPickGallery" type="button">üñºÔ∏è Scegli dalla galleria</button>

          <input id="fotoCamera" type="file" accept="image/*" capture="environment" class="hidden" />
          <input id="fotoGallery" type="file" accept="image/*" multiple class="hidden" />

          <button class="danger" id="btnClearPhoto" type="button">üßπ Rimuovi</button>
        </div>

        <div id="photoPreview" class="preview">
          <div style="display:flex;flex-direction:column;gap:8px;min-width:170px">
            <div style="font-weight:980;color:var(--text)">Anteprima foto</div>
            <div id="photoMeta" class="hint" style="margin:0"></div>
          </div>
          <div class="thumbs" id="thumbs"></div>
        </div>

        <div class="toggle">
          <div>
            <strong>Invia anche in forma anonima</strong><br>
            <span>Se disattivi, puoi lasciare un contatto per essere richiamato</span>
          </div>
          <input id="anonimo" type="checkbox" />
        </div>

        <div id="contactBox" class="contactBox hidden">
          <div class="contactTitle">üìå Dati per essere contattato</div>
          <div class="hint" style="margin:0 0 10px">Inserisci almeno <b>Email</b> o <b>Telefono</b>.</div>

          <div class="contactGrid">
            <div>
              <label for="contactName">Nome e Cognome (opzionale)</label>
              <input id="contactName" type="text" maxlength="80" placeholder="Es. Mario Rossi" />
            </div>
            <div>
              <label for="contactPhone">Telefono (opzionale)</label>
              <input id="contactPhone" type="tel" maxlength="30" placeholder="Es. 333 123 4567" />
            </div>
            <div style="grid-column: 1 / -1;">
              <label for="contactEmail">Email (opzionale)</label>
              <input id="contactEmail" type="email" maxlength="120" placeholder="Es. nome@email.it" />
            </div>
          </div>
        </div>

        <!-- PROGRESS -->
        <div id="progressWrap" class="progressWrap">
          <div class="progressTop">
            <div class="progressTitle">üöÄ Invio in corso‚Ä¶</div>
            <div class="stepPill" id="progressStep">1/3</div>
          </div>
          <div class="bar"><span id="progressBar"></span></div>
          <div class="progressHint" id="progressHint">Preparazione‚Ä¶</div>
        </div>

        <div class="btnRow">
          <button class="primary" id="btnSend" type="button">‚úÖ Invia</button>
          <a class="btn ghost" href="#/my">üóÇÔ∏è Vedi storico</a>
        </div>

        <div class="hint">
          La segnalazione viene salvata sul dispositivo.
        </div>
      </div>
    </section>

    <!-- SUCCESS -->
    <section id="view-success" class="grid hidden">
      <div class="card">
        <div class="ok">
          <div style="font-size:22px">‚úÖ</div>
          <div>
            <div style="font-weight:980;font-size:18px">Segnalazione inviata correttamente</div>
            <div class="hint" style="margin:6px 0 0">Salvata in locale. Grazie.</div>
          </div>
        </div>

        <div class="btnRow" style="margin-top:14px">
          <a class="btn primary" href="#/">üè† Torna alla Home</a>
          <a class="btn ghost" href="#/my">üóÇÔ∏è Le mie segnalazioni</a>
          <a class="btn ghost" href="#/report">‚ûï Nuova segnalazione</a>
        </div>
      </div>
    </section>

    <!-- MY REPORTS -->
    <section id="view-my" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:980;font-size:18px">Le mie segnalazioni</div>
            <div class="hint" style="margin:6px 0 0">Salvate in locale sul dispositivo.</div>
          </div>
          <div class="row" style="flex:0 0 auto">
            <a class="btn small ghost" href="#/report">‚ûï Nuova</a>
            <button class="btn small danger" id="btnClearAll" type="button">üóëÔ∏è Svuota</button>
          </div>
        </div>

        <div id="emptyState" class="hint" style="margin-top:12px">
          <div class="emptyState">
            <div class="emptyIcon">üìÇ</div>
            <h3 style="margin:0 0 6px;font-weight:980;">Nessuna segnalazione</h3>
            <p style="margin:0;color:var(--muted);line-height:1.45;">Quando invii una segnalazione, la troverai qui.</p>
          </div>
        </div>

        <div id="list" class="list"></div>
      </div>
    </section>

    <!-- CONTACTS -->
    <section id="view-contacts" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:980;font-size:18px">Contatti</div>
            <div class="hint" style="margin:6px 0 0">Per comunicazioni generali.</div>
          </div>
          <a class="btn small ghost" href="#/">‚Üê Home</a>
        </div>

        <div class="btnRow" style="margin-top:14px">
          <a class="btn ghost" id="mailLink" href="#">‚úâÔ∏è Email</a>
          <a class="btn ghost" id="mapLink" href="#" target="_blank" rel="noreferrer">üìç Posizione</a>
        </div>
      </div>
    </section>
  </div>

  <!-- nota sopra la tabbar (non dentro la barra) -->
  <div class="tabbarNoteWrap" aria-hidden="true">
    <div class="tabbarNote">Risposta garantita nel minor tempo possibile.</div>
  </div>

  <!-- PREMIUM TAB BAR -->
  <nav class="tabbar" role="navigation" aria-label="Navigazione">
    <button class="tab is-active" data-tab="home" type="button" aria-label="Home">
      <span class="ico">üè†</span>
      <span class="lbl">Home</span>
    </button>

    <button class="tab" data-tab="report" type="button" aria-label="Segnala">
      <span class="ico">üìù</span>
      <span class="lbl">Segnala</span>
    </button>

    <button class="tab" data-tab="my" type="button" aria-label="Storico">
      <span class="ico">üóÇÔ∏è</span>
      <span class="lbl">Storico</span>
    </button>

    <button class="tab" data-tab="contacts" type="button" aria-label="Contatti">
      <span class="ico">üë§</span>
      <span class="lbl">Contatti</span>
    </button>

    <span class="tab-indicator" aria-hidden="true"></span>
  </nav>

  <script>
    // =========================
    // CONFIG
    // =========================
    const CONFIG = {
      email: "vocidicassino@proton.me",
      mapsQuery: "Cassino",

      // Worker (invio segnalazioni)
      telegramWorkerUrl: "https://segnalafacile-telegram.vocidicassino.workers.dev",
      telegramApiKey: "Marco-Admin-2026"
    };

    // =========================
    // Banner helper
    // =========================
    const banner = document.getElementById("banner");
    const bannerText = document.getElementById("bannerText");
    const bannerClose = document.getElementById("bannerClose");
    let bannerTimer = null;

    function showBanner(type, text, autoHideMs = 0){
      if (bannerTimer) { clearTimeout(bannerTimer); bannerTimer = null; }
      banner.classList.remove("hidden","info","success","error");
      banner.classList.add(type || "info");
      bannerText.textContent = text || "";
      if (autoHideMs && autoHideMs > 0){
        bannerTimer = setTimeout(() => hideBanner(), autoHideMs);
      }
    }
    function hideBanner(){
      if (bannerTimer) { clearTimeout(bannerTimer); bannerTimer = null; }
      banner.classList.add("hidden");
      banner.classList.remove("info","success","error");
      bannerText.textContent = "";
    }
    bannerClose.addEventListener("click", hideBanner);

    // =========================
    // PWA install prompt
    // =========================
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const pill = document.getElementById("installPill");
      pill.style.display = "inline-flex";
      pill.addEventListener("click", async () => {
        try{
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          pill.style.display = "none";
        }catch{}
      }, { once:true });
    });

    // =========================
    // Router
    // =========================
    const views = {
      home: document.getElementById("view-home"),
      report: document.getElementById("view-report"),
      success: document.getElementById("view-success"),
      my: document.getElementById("view-my"),
      contacts: document.getElementById("view-contacts"),
    };

    function showView(key){
      Object.values(views).forEach(v => v.classList.add("hidden"));
      views[key].classList.remove("hidden");
      setActiveTab(key);
      if(key === "my") renderList();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function route(){
      const hash = (location.hash || "#/").replace("#/", "");
      const key = hash || "";
      if(key === "" ) return showView("home");
      if(key === "report") return showView("report");
      if(key === "success") return showView("success");
      if(key === "my") return showView("my");
      if(key === "contacts") return showView("contacts");
      showView("home");
    }
    window.addEventListener("hashchange", route);

    // =========================
    // Contacts (Email + Mappa)
    // =========================
    const mail = document.getElementById("mailLink");
    const map = document.getElementById("mapLink");

    function applyContacts(){
      const subject = "Messaggio da SegnalaFacile";
      const body = "Ciao,%0D%0A%0D%0AScrivo da SegnalaFacile:%0D%0A";
      mail.href = `mailto:${CONFIG.email}?subject=${encodeURIComponent(subject)}&body=${body}`;
      map.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(CONFIG.mapsQuery)}`;
    }
    applyContacts();

    // =========================
    // Storage
    // =========================
    const STORAGE_KEY = "segnalafacile_reports_v5";

    function loadReports(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch{ return []; }
    }
    function saveReports(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    // =========================
    // Form + multi-photo
    // =========================
    const elTitolo = document.getElementById("titolo");
    const elDescrizione = document.getElementById("descrizione");
    const elAnonimo = document.getElementById("anonimo");

    const elContactBox = document.getElementById("contactBox");
    const elContactName = document.getElementById("contactName");
    const elContactPhone = document.getElementById("contactPhone");
    const elContactEmail = document.getElementById("contactEmail");

    const elFotoCamera = document.getElementById("fotoCamera");
    const elFotoGallery = document.getElementById("fotoGallery");

    const btnPickCamera = document.getElementById("btnPickCamera");
    const btnPickGallery = document.getElementById("btnPickGallery");

    const btnClearPhoto = document.getElementById("btnClearPhoto");
    const btnSend = document.getElementById("btnSend");

    const preview = document.getElementById("photoPreview");
    const photoMeta = document.getElementById("photoMeta");
    const thumbs = document.getElementById("thumbs");

    // progress UI
    const progressWrap = document.getElementById("progressWrap");
    const progressStep = document.getElementById("progressStep");
    const progressBar = document.getElementById("progressBar");
    const progressHint = document.getElementById("progressHint");

    let photos = []; // [{dataUrl, name, type, blobSize}]

    function toggleContactBox(){
      const isAnon = !!elAnonimo.checked;
      elContactBox.classList.toggle("hidden", isAnon);
    }
    elAnonimo.addEventListener("change", toggleContactBox);
    toggleContactBox();

    btnPickCamera.addEventListener("click", () => elFotoCamera.click());
    btnPickGallery.addEventListener("click", () => elFotoGallery.click());

    btnClearPhoto.addEventListener("click", () => {
      elFotoCamera.value = "";
      elFotoGallery.value = "";
      photos = [];
      renderPhotoPreview();
      showBanner("info", "Foto rimosse.", 1800);
    });

    function formatBytes(bytes){
      if (!bytes && bytes !== 0) return "";
      const units = ["B","KB","MB","GB"];
      let i = 0, n = bytes;
      while(n >= 1024 && i < units.length-1){ n /= 1024; i++; }
      return `${n.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
    }

    async function fileToCompressedJpegDataUrl(file){
      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.onload = () => resolve(i);
        i.onerror = reject;
        i.src = URL.createObjectURL(file);
      });

      const maxSide = 1400;
      let w = img.naturalWidth, h = img.naturalHeight;
      const ratio = Math.min(1, maxSide / Math.max(w,h));
      w = Math.round(w * ratio);
      h = Math.round(h * ratio);

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);

      const quality = 0.82;
      const dataUrl = canvas.toDataURL("image/jpeg", quality);
      const blob = await (await fetch(dataUrl)).blob();
      return { dataUrl, blob };
    }

    function renderPhotoPreview(){
      thumbs.innerHTML = "";

      if(!photos.length){
        preview.style.display = "none";
        photoMeta.textContent = "";
        return;
      }

      preview.style.display = "flex";
      const totalBytes = photos.reduce((s,p) => s + (p.blobSize || 0), 0);
      photoMeta.textContent = `${photos.length} foto selezionate ‚Ä¢ ${formatBytes(totalBytes)}`;

      photos.forEach(p => {
        const im = document.createElement("img");
        im.src = p.dataUrl;
        im.alt = p.name || "foto";
        thumbs.appendChild(im);
      });
    }

    async function addFiles(fileList, replace = false){
      const files = Array.from(fileList || []).filter(Boolean);
      if(!files.length) return;

      if(replace) photos = [];

      const MAX = 6;
      const space = MAX - photos.length;
      const picked = files.slice(0, Math.max(0, space));

      if(files.length > picked.length){
        showBanner("info", `Massimo ${MAX} foto. Selezionate le prime ${picked.length}.`, 4500);
      }

      for(const f of picked){
        const name = f.name || "foto.jpg";
        const type = f.type || "image/jpeg";
        const { dataUrl, blob } = await fileToCompressedJpegDataUrl(f);
        photos.push({ dataUrl, name, type, blobSize: blob.size });
      }

      renderPhotoPreview();
    }

    elFotoCamera.addEventListener("change", async (e) => {
      await addFiles(e.target.files, true);
    });

    elFotoGallery.addEventListener("change", async (e) => {
      await addFiles(e.target.files, false);
    });

    // =========================
    // Reports list UI
    // =========================
    const listEl = document.getElementById("list");
    const emptyState = document.getElementById("emptyState");
    const btnClearAll = document.getElementById("btnClearAll");

    function renderList(){
      const arr = loadReports();
      listEl.innerHTML = "";
      emptyState.style.display = arr.length ? "none" : "block";

      arr.slice().reverse().forEach((r) => {
        const item = document.createElement("div");
        item.className = "item";

        const img = document.createElement("img");
        img.className = "thumb";
        img.alt = "Foto";
        img.src = r.photoDataUrl || "";
        if(!r.photoDataUrl) img.style.display = "none";

        const body = document.createElement("div");
        body.style.flex = "1";

        const h3 = document.createElement("h3");
        h3.textContent = r.titolo || "(senza titolo)";

        const p = document.createElement("p");
        p.textContent = r.descrizione || "";

        const meta = document.createElement("div");
        meta.className = "metaRow";

        const pill1 = document.createElement("span");
        pill1.className = "pill";
        pill1.textContent = "üïí " + (r.when || "");

        const pill2 = document.createElement("span");
        pill2.className = "pill";
        pill2.textContent = r.anonimo ? "üï∂Ô∏è Anonimo" : "üìå Contatto";

        const pill3 = document.createElement("span");
        pill3.className = "pill";
        pill3.textContent = r.photoDataUrl ? "üì∑ Foto" : "üì∑ Nessuna foto";

        meta.append(pill1,pill2,pill3);
        body.append(h3,p,meta);
        item.append(img, body);
        listEl.append(item);
      });
    }

    btnClearAll.addEventListener("click", () => {
      if(!confirm("Vuoi svuotare lo storico locale?")) return;
      saveReports([]);
      renderList();
      showBanner("info", "Storico svuotato.", 2500);
    });

    // =========================
    // Send
    // =========================
    async function sendToWorker(payload){
      const url = new URL(CONFIG.telegramWorkerUrl);
      const res = await fetch(url.toString(), {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Api-Key": CONFIG.telegramApiKey || ""
        },
        body: JSON.stringify(payload)
      });

      let data = null;
      try { data = await res.json(); } catch {}
      if(!res.ok || !data || data.ok !== true){
        const msg = data?.error ? `${data.error}` : `HTTP_${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    function isValidEmail(v){
      const s = String(v || "").trim();
      if(!s) return false;
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
    }

    function showProgress(step, hint){
      progressWrap.style.display = "block";
      progressStep.textContent = `${step}/3`;
      progressHint.textContent = hint || "";
      const pct = step === 1 ? 33 : step === 2 ? 66 : 100;
      progressBar.style.width = pct + "%";
    }
    function hideProgress(){
      progressWrap.style.display = "none";
      progressBar.style.width = "0%";
      progressStep.textContent = "1/3";
      progressHint.textContent = "";
    }

    btnSend.addEventListener("click", async () => {
      const titolo = (elTitolo.value || "").trim();
      const descrizione = (elDescrizione.value || "").trim();

      if(titolo.length < 4){
        showBanner("error", "Inserisci un titolo (minimo 4 caratteri).", 3500);
        return;
      }
      if(descrizione.length < 10){
        showBanner("error", "Inserisci una descrizione (minimo 10 caratteri).", 3500);
        return;
      }

      const isAnon = !!elAnonimo.checked;
      const contactName = (elContactName?.value || "").trim();
      const contactPhone = (elContactPhone?.value || "").trim();
      const contactEmail = (elContactEmail?.value || "").trim();

      if(!isAnon){
        const okEmail = contactEmail ? isValidEmail(contactEmail) : false;
        const okPhone = contactPhone.length >= 6;
        if(!okEmail && !okPhone){
          showBanner("error", "Se NON anonimo, inserisci almeno Email o Telefono.", 4500);
          return;
        }
      }

      btnSend.disabled = true;
      showBanner("info", "Invio in corso‚Ä¶");
      showProgress(1, "Preparazione dati‚Ä¶");

      const now = new Date();
      const first = photos[0] || null;

      const payload = {
        titolo,
        descrizione,
        anonimo: isAnon,
        when: now.toLocaleString("it-IT"),
        source: "SegnalaFacile PWA",

        contactName: isAnon ? "" : contactName,
        contactEmail: isAnon ? "" : contactEmail,
        contactPhone: isAnon ? "" : contactPhone,

        photo: first ? {
          dataUrl: first.dataUrl,
          name: first.name || "foto.jpg",
          type: first.type || "image/jpeg"
        } : null,

        photos: photos.map(p => ({
          dataUrl: p.dataUrl,
          name: p.name || "foto.jpg",
          type: p.type || "image/jpeg"
        }))
      };

      // salva in locale subito
      const arr = loadReports();
      arr.push({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
        titolo,
        descrizione,
        anonimo: isAnon,
        when: payload.when,
        photoDataUrl: first ? first.dataUrl : null
      });
      saveReports(arr);

      try{
        showProgress(2, "Invio al server‚Ä¶");
        await sendToWorker(payload);

        showProgress(3, "Conferma invio‚Ä¶");
        await new Promise(r => setTimeout(r, 220));

        hideBanner();
        hideProgress();
        location.hash = "#/success";
        showBanner("success", "Segnalazione inviata ‚úÖ", 3000);

        // reset
        elTitolo.value = "";
        elDescrizione.value = "";
        elAnonimo.checked = false;
        toggleContactBox();
        elContactName.value = "";
        elContactPhone.value = "";
        elContactEmail.value = "";

        elFotoCamera.value = "";
        elFotoGallery.value = "";
        photos = [];
        renderPhotoPreview();

      }catch(e){
        hideProgress();
        hideBanner();
        location.hash = "#/success";
        showBanner("error", "Invio non riuscito (nessun dato perso).", 6000);
        console.warn("Worker error:", e);
      }finally{
        btnSend.disabled = false;
      }
    });

    // =========================
    // Premium tabbar logic
    // =========================
    const tabs = Array.from(document.querySelectorAll(".tabbar .tab"));
    const indicator = document.querySelector(".tabbar .tab-indicator");

    function setActiveTab(key){
      // se sei in success, evidenzia HOME (cos√¨ non impazzisce)
      const normalized = (key === "success") ? "home" : key;

      tabs.forEach(t => t.classList.toggle("is-active", t.dataset.tab === normalized));
      const active = tabs.find(t => t.dataset.tab === normalized) || tabs[0];

      // sposta indicatore
      const idx = tabs.indexOf(active);
      const gap = 8;
      // larghezza calcolata in CSS: (container - padding - padding)/4
      // qui ci basta traslare di "slot"
      indicator.style.transform = `translateX(${idx * (indicator.offsetWidth + gap)}px)`;
    }

    tabs.forEach(tab=>{
      tab.addEventListener("click", () => {
        const key = tab.dataset.tab;
        location.hash = key === "home" ? "#/" : `#/${key}`;
      });
    });

    // init
    route();
    renderPhotoPreview();
    renderList();
    // allinea indicatore subito
    requestAnimationFrame(() => setActiveTab("home"));
  </script>
</body>
</html>
