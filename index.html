<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>SegnalaFacile</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    :root{
      --bg:#0b1220; --text:#e8eefc;
      --muted:#a8b4d6; --accent:#2d7dff; --accent2:#19c37d; --danger:#ff4d4f;
      --stroke:rgba(255,255,255,.10);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(45,125,255,.25), transparent 50%),
                  radial-gradient(1000px 700px at 80% 10%, rgba(25,195,125,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:860px; margin:0 auto; padding:22px 16px 90px}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 0 6px;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background:url("icons/icon-192.png") center/cover no-repeat,linear-gradient(135deg, rgba(45,125,255,.95), rgba(25,195,125,.9));
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    .title{font-size:18px; font-weight:800; letter-spacing:.2px}
    .badge{
      font-size:12px; color:var(--muted);
      border:1px solid var(--stroke); padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.04);
    }

    .grid{display:grid; gap:14px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius:var(--r);
      padding:16px;
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
    }
    .hero h1{margin:0 0 8px; font-size:28px; line-height:1.15}
    .hero p{margin:0; color:var(--muted); font-size:14px; line-height:1.5}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}

    button, .btn{
      cursor:pointer; border:0; border-radius:14px;
      padding:12px 14px; font-weight:700; font-size:14px;
      display:inline-flex; align-items:center; gap:10px;
      text-decoration:none; color:var(--text);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    button:disabled{
      opacity:.65;
      cursor:not-allowed;
      transform:none !important;
    }

    .primary{background:var(--accent)}
    .ghost{background:rgba(255,255,255,.06); border:1px solid var(--stroke)}
    .danger{background:rgba(255,77,79,.14); border:1px solid rgba(255,77,79,.35)}
    .small{padding:10px 12px; border-radius:12px; font-size:13px}

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row > *{flex:1 1 220px}

    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input[type="text"], textarea{
      width:100%; padding:12px 12px; border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:110px; resize:vertical}
    .hint{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.45}

    .toggle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border-radius:14px; border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      margin-top:10px;
    }
    .toggle span{color:var(--muted); font-size:13px}
    .toggle strong{font-size:13px}

    .preview{
      margin-top:10px; display:none;
      padding:12px; border-radius:14px; border:1px dashed var(--stroke);
      background:rgba(0,0,0,.15);
    }
    .previewHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .previewHead .meta{
      font-size:12px; color:var(--muted); line-height:1.4;
    }

    .thumbGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap:10px;
    }
    .thumbCard{
      position:relative;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      aspect-ratio: 1 / 1;
    }
    .thumbCard img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .thumbRemove{
      position:absolute;
      top:6px; right:6px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.45);
      color: var(--text);
      border-radius: 10px;
      padding: 6px 8px;
      font-weight: 900;
      font-size: 12px;
      line-height: 1;
    }
    .thumbTag{
      position:absolute;
      left:8px; bottom:8px;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.45);
      color:var(--text);
      max-width: calc(100% - 16px);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.06); border:1px solid var(--stroke);
      color:var(--muted); font-size:12px;
    }

    .list{display:grid; gap:10px; margin-top:12px}
    .item{
      padding:12px; border-radius:16px;
      background:rgba(0,0,0,.18);
      border:1px solid var(--stroke);
      display:flex; gap:12px; align-items:flex-start;
    }
    .thumb{
      width:64px; height:64px; border-radius:14px; border:1px solid var(--stroke);
      object-fit:cover; background:rgba(255,255,255,.05)
    }
    .item h3{margin:0; font-size:14px}
    .item p{margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.45}
    .metaRow{margin-top:8px; display:flex; flex-wrap:wrap; gap:8px}

    nav.bottom{
      position:fixed; left:0; right:0; bottom:0;
      background:rgba(9,14,28,.78);
      border-top:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      z-index:9999;
    }
    nav .inner{
      max-width:860px; margin:0 auto;
      display:flex; justify-content:space-around; gap:8px;
      padding:10px 10px;
    }
    nav a{
      flex:1; text-align:center; text-decoration:none; color:var(--muted);
      font-size:12px; padding:10px 8px; border-radius:14px;
      border:1px solid transparent;
      touch-action: manipulation;
    }
    nav a.active{
      color:var(--text);
      background:rgba(255,255,255,.06);
      border-color:var(--stroke);
    }

    .hidden{display:none !important}
    .ok{
      display:flex; align-items:center; gap:10px;
      padding:12px; border-radius:16px; border:1px solid rgba(25,195,125,.35);
      background:rgba(25,195,125,.12);
      color:var(--text);
    }

    /* Router: mostra solo la section non-hidden */
    section{display:none;}
    section:not(.hidden){display:block;}

    /* =========================
       BANNER (in alto, bello)
       ========================= */
    .banner{
      position: sticky;
      top: 10px;
      z-index: 2000;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      margin: 0 0 12px;
    }
    .banner .text{
      font-size:13px;
      line-height:1.35;
      color: var(--text);
      word-break: break-word;
    }
    .banner .close{
      flex: 0 0 auto;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight:800;
    }
    .banner.info{
      border-color: rgba(45,125,255,.35);
      background: rgba(45,125,255,.10);
    }
    .banner.success{
      border-color: rgba(25,195,125,.35);
      background: rgba(25,195,125,.12);
    }
    .banner.error{
      border-color: rgba(255,77,79,.35);
      background: rgba(255,77,79,.12);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">SegnalaFacile</div>
          <div class="badge">PWA installabile ‚Ä¢ salvataggio locale + invio gruppo TelegramSegnala Facile</div>
        </div>
      </div>
      <div class="pill" id="installPill" style="display:none;">‚¨áÔ∏è Installa</div>
    </header>

    <!-- BANNER (globale, visibile su tutte le viste) -->
    <div id="banner" class="banner hidden" role="status" aria-live="polite">
      <div class="text" id="bannerText"></div>
      <button class="close" id="bannerClose" type="button">‚úï</button>
    </div>

    <!-- HOME -->
    <section id="view-home" class="grid">
      <div class="card hero">
        <h1>Invia una segnalazione in pochi secondi</h1>
        <p>Descrivi il problema, aggiungi una foto e invia. Niente messaggi sparsi: tutto ordinato e tracciabile.</p>
        <div class="btnRow">
          <a class="btn primary" href="#/report">üìù Invia segnalazione</a>
          <a class="btn ghost" href="#/contacts">‚òéÔ∏è Contatti rapidi</a>
          <a class="btn ghost" href="#/my">üóÇÔ∏è Le mie segnalazioni</a>
        </div>
        <div class="hint">Nessuna registrazione richiesta. Salvataggio locale + inoltro su gruppo Telegram Segnala Facile.</div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
          <div>
            <div style="font-weight:800;margin-bottom:4px">Come funziona</div>
            <div class="hint" style="margin:0">1) Compili ‚Ä¢ 2) Aggiungi foto (camera o galleria) ‚Ä¢ 3) Invi ‚Ä¢ 4) Ti resta lo storico</div>
          </div>
          <a class="btn small ghost" href="#/report">Prova ora ‚Üí</a>
        </div>
      </div>
    </section>

    <!-- REPORT -->
    <section id="view-report" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:900;font-size:18px">Nuova segnalazione</div>
            <div class="hint" style="margin:6px 0 0">Compila i campi e premi ‚ÄúInvia‚Äù.</div>
          </div>
          <a class="btn small ghost" href="#/">‚Üê Home</a>
        </div>

        <label for="titolo">Titolo</label>
        <input id="titolo" type="text" maxlength="80" placeholder="Es. Lampione spento in via‚Ä¶" />

        <label for="descrizione">Descrizione</label>
        <textarea id="descrizione" maxlength="700" placeholder="Spiega cosa succede, dove e quando‚Ä¶"></textarea>

        <label>Foto (opzionale)</label>
        <div class="row">
          <button class="ghost" id="btnPickCamera" type="button">üì∑ Scatta foto</button>
          <button class="ghost" id="btnPickGallery" type="button">üñºÔ∏è Scegli dalla galleria</button>

          <!-- Input fotocamera (di solito 1 foto) -->
          <input id="fotoCamera" type="file" accept="image/*" capture="environment" class="hidden" />
          <!-- Input galleria (MULTI FOTO) -->
          <input id="fotoGallery" type="file" accept="image/*" multiple class="hidden" />

          <button class="danger" id="btnClearPhoto" type="button">üßπ Rimuovi</button>
        </div>

        <div id="photoPreview" class="preview">
          <div class="previewHead">
            <div class="meta">
              <div style="font-weight:800;color:var(--text)">Foto selezionate</div>
              <div id="photoMeta"></div>
              <div class="hint" style="margin-top:8px">Se presenti, le foto vengono inoltrate sul gruppo Telegram Segnala Facile come allegati (album).</div>
            </div>
            <span class="pill" id="photoCountPill">0 foto</span>
          </div>
          <div class="thumbGrid" id="thumbGrid"></div>
        </div>

        <div class="toggle">
          <div>
            <strong>Invia anche in forma anonima</strong><br>
            <span>Nessun nome richiesto</span>
          </div>
          <input id="anonimo" type="checkbox" />
        </div>

        <div class="btnRow">
          <button class="primary" id="btnSend" type="button">‚úÖ Invia</button>
          <a class="btn ghost" href="#/my">üóÇÔ∏è Vedi storico</a>
        </div>

        <div class="hint">
          Nota: salvataggio locale + inoltro su gruppo Telegram Segnala Facile.
        </div>
      </div>
    </section>

    <!-- SUCCESS -->
    <section id="view-success" class="grid hidden">
      <div class="card">
        <div class="ok">
          <div style="font-size:22px">‚úÖ</div>
          <div>
            <div style="font-weight:900;font-size:18px" id="successTitle">Segnalazione inviata correttamente</div>
            <div class="hint" style="margin:6px 0 0" id="successHint">Salvata in locale e inoltrata su gruppo Telegram Segnala Facile.</div>
          </div>
        </div>

        <div class="btnRow" style="margin-top:14px">
          <a class="btn primary" href="#/">üè† Torna alla Home</a>
          <a class="btn ghost" href="#/my">üóÇÔ∏è Le mie segnalazioni</a>
          <a class="btn ghost" href="#/report">‚ûï Nuova segnalazione</a>
        </div>
      </div>
    </section>

    <!-- MY REPORTS -->
    <section id="view-my" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:900;font-size:18px">Le mie segnalazioni</div>
            <div class="hint" style="margin:6px 0 0">Salvate in locale sul dispositivo.</div>
          </div>
          <div class="row" style="flex:0 0 auto">
            <a class="btn small ghost" href="#/report">‚ûï Nuova</a>
            <button class="btn small danger" id="btnClearAll" type="button">üóëÔ∏è Svuota</button>
          </div>
        </div>

        <div id="emptyState" class="hint" style="margin-top:12px">
          Nessuna segnalazione salvata. Prova a inviarne una dalla schermata ‚ÄúSegnala‚Äù.
        </div>

        <div id="list" class="list"></div>
      </div>
    </section>

    <!-- CONTACTS -->
    <section id="view-contacts" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:900;font-size:18px">Contatti rapidi</div>
            <div class="hint" style="margin:6px 0 0">Un solo punto di contatto. Niente messaggi persi.</div>
          </div>
          <a class="btn small ghost" href="#/">‚Üê Home</a>
        </div>

        <div class="btnRow" style="margin-top:14px">
          <a class="btn ghost" id="tgLink" href="#" target="_blank" rel="noreferrer">üí¨ Telegram</a>
          <a class="btn ghost" id="mailLink" href="#">‚úâÔ∏è Email</a>
          <a class="btn ghost" id="mapLink" href="#" target="_blank" rel="noreferrer">üìç Posizione</a>
        </div>

        <div class="hint" style="margin-top:12px">
          Modifica questi contatti dentro <b>index.html</b> nella sezione ‚ÄúCONFIG‚Äù.
        </div>
      </div>
    </section>
  </div>

  <nav class="bottom">
    <div class="inner">
      <a href="#/" data-nav="home" class="active">üè† Home</a>
      <a href="#/report" data-nav="report">üìù Segnala</a>
      <a href="#/my" data-nav="my">üóÇÔ∏è Storico</a>
      <a href="#/contacts" data-nav="contacts">‚òéÔ∏è Contatti</a>
    </div>
  </nav>

  <script>
    // =========================
    // CONFIG (personalizza qui)
    // =========================
    const CONFIG = {
      telegramUsername: "SegnalaFacileBot",
      email: "vocidicassino@proton.me",
      mapsQuery: "Cassino",

      // Worker (invio segnalazioni a Telegram)
      telegramWorkerUrl: "https://segnalafacile-telegram.vocidicassino.workers.dev",
      telegramApiKey: "Marco-Admin-2026"
    };

    // =========================
    // Banner helper
    // =========================
    const banner = document.getElementById("banner");
    const bannerText = document.getElementById("bannerText");
    const bannerClose = document.getElementById("bannerClose");
    let bannerTimer = null;

    function showBanner(type, text, autoHideMs = 0){
      if (bannerTimer) { clearTimeout(bannerTimer); bannerTimer = null; }
      banner.classList.remove("hidden","info","success","error");
      banner.classList.add(type || "info");
      bannerText.textContent = text || "";
      if (autoHideMs && autoHideMs > 0){
        bannerTimer = setTimeout(() => hideBanner(), autoHideMs);
      }
    }
    function hideBanner(){
      if (bannerTimer) { clearTimeout(bannerTimer); bannerTimer = null; }
      banner.classList.add("hidden");
      banner.classList.remove("info","success","error");
      bannerText.textContent = "";
    }
    bannerClose.addEventListener("click", hideBanner);

    // =========================
    // PWA install prompt
    // =========================
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const pill = document.getElementById("installPill");
      pill.style.display = "inline-flex";
      pill.addEventListener("click", async () => {
        try{
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          pill.style.display = "none";
        }catch{}
      }, { once:true });
    });

    // =========================
    // Simple router
    // =========================
    const views = {
      home: document.getElementById("view-home"),
      report: document.getElementById("view-report"),
      success: document.getElementById("view-success"),
      my: document.getElementById("view-my"),
      contacts: document.getElementById("view-contacts"),
    };

    const navLinks = Array.from(document.querySelectorAll("nav a[data-nav]"));
    function setActiveNav(key){
      navLinks.forEach(a => a.classList.toggle("active", a.dataset.nav === key));
    }

    function showView(key){
      Object.values(views).forEach(v => v.classList.add("hidden"));
      views[key].classList.remove("hidden");
      setActiveNav(key);
      if(key === "my") renderList();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function route(){
      const hash = (location.hash || "#/").replace("#/", "");
      const key = hash || "";
      if(key === "" ) return showView("home");
      if(key === "report") return showView("report");
      if(key === "success") return showView("success");
      if(key === "my") return showView("my");
      if(key === "contacts") return showView("contacts");
      showView("home");
    }
    window.addEventListener("hashchange", route);

    // =========================
    // Contacts links
    // =========================
    const mail = document.getElementById("mailLink");
    const map = document.getElementById("mapLink");
    const tg = document.getElementById("tgLink");

    function applyContacts(){
      const subject = "Segnalazione da SegnalaFacile";
      const body = "Ciao,%0D%0A%0D%0AScrivo da SegnalaFacile:%0D%0A";
      mail.href = `mailto:${CONFIG.email}?subject=${encodeURIComponent(subject)}&body=${body}`;
      map.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(CONFIG.mapsQuery)}`;
      tg.href = "https://t.me/" + CONFIG.telegramUsername;
    }
    applyContacts();

    // =========================
    // Local storage for reports
    // =========================
    const STORAGE_KEY = "segnalafacile_reports_v4";

    function loadReports(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch{ return []; }
    }
    function saveReports(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    // =========================
    // Form logic + multi photo
    // =========================
    const elTitolo = document.getElementById("titolo");
    const elDescrizione = document.getElementById("descrizione");
    const elAnonimo = document.getElementById("anonimo");

    const elFotoCamera = document.getElementById("fotoCamera");
    const elFotoGallery = document.getElementById("fotoGallery");

    const btnPickCamera = document.getElementById("btnPickCamera");
    const btnPickGallery = document.getElementById("btnPickGallery");

    const btnClearPhoto = document.getElementById("btnClearPhoto");
    const btnSend = document.getElementById("btnSend");

    const preview = document.getElementById("photoPreview");
    const photoMeta = document.getElementById("photoMeta");
    const thumbGrid = document.getElementById("thumbGrid");
    const photoCountPill = document.getElementById("photoCountPill");

    const successTitle = document.getElementById("successTitle");
    const successHint = document.getElementById("successHint");

    // ‚úÖ Array di foto (max 10)
    let photos = []; // [{ dataUrl, name, type }]

    btnPickCamera.addEventListener("click", () => elFotoCamera.click());
    btnPickGallery.addEventListener("click", () => elFotoGallery.click());

    btnClearPhoto.addEventListener("click", () => {
      elFotoCamera.value = "";
      elFotoGallery.value = "";
      photos = [];
      renderPhotoPreview();
      showBanner("info", "Foto rimosse.", 2000);
    });

    elFotoCamera.addEventListener("change", async (e) => {
      const file = (e.target.files && e.target.files[0]) ? e.target.files[0] : null;
      if (!file) return;

      // aggiunge 1 foto (camera)
      if (photos.length >= 10) {
        showBanner("error", "Hai gi√† selezionato 10 foto (limite Telegram).", 3500);
        return;
      }

      try{
        const dataUrl = await readAndCompressImage(file, 1280, 0.78);
        photos.push({
          dataUrl,
          name: file.name || `foto_${Date.now()}.jpg`,
          type: file.type || "image/jpeg"
        });
        renderPhotoPreview();
      }catch(err){
        showBanner("error", "Errore lettura foto (camera).", 3500);
      }finally{
        elFotoCamera.value = "";
      }
    });

    elFotoGallery.addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      // max 10
      const space = 10 - photos.length;
      if (space <= 0) {
        showBanner("error", "Hai gi√† selezionato 10 foto (limite Telegram).", 3500);
        elFotoGallery.value = "";
        return;
      }

      const toAdd = files.slice(0, space);

      try{
        for (const f of toAdd) {
          const dataUrl = await readAndCompressImage(f, 1280, 0.78);
          photos.push({
            dataUrl,
            name: f.name || `foto_${Date.now()}.jpg`,
            type: f.type || "image/jpeg"
          });
        }
        if (files.length > toAdd.length) {
          showBanner("info", "Aggiunte le prime 10 foto (limite Telegram).", 3500);
        }
        renderPhotoPreview();
      }catch(err){
        showBanner("error", "Errore lettura foto (galleria).", 3500);
      }finally{
        elFotoGallery.value = "";
      }
    });

    function renderPhotoPreview(){
      const n = photos.length;
      if (!n) {
        preview.style.display = "none";
        thumbGrid.innerHTML = "";
        photoMeta.textContent = "";
        photoCountPill.textContent = "0 foto";
        return;
      }

      preview.style.display = "block";
      photoCountPill.textContent = `${n} foto`;
      photoMeta.textContent = `Puoi inviare fino a 10 foto. Attuali: ${n}.`;

      thumbGrid.innerHTML = photos.map((p, idx) => {
        const safeName = escapeHtml(p.name || `foto_${idx+1}.jpg`);
        return `
          <div class="thumbCard">
            <img src="${p.dataUrl}" alt="Foto ${idx+1}">
            <button class="thumbRemove" type="button" data-remove="${idx}">‚úï</button>
            <div class="thumbTag">${safeName}</div>
          </div>
        `;
      }).join("");

      // bind remove
      thumbGrid.querySelectorAll("button[data-remove]").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = Number(btn.getAttribute("data-remove"));
          if (Number.isFinite(i)) {
            photos.splice(i, 1);
            renderPhotoPreview();
          }
        });
      });
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function readAndCompressImage(file, maxSide = 1280, quality = 0.78){
      // legge immagine -> ridimensiona lato maxSide -> jpeg compresso -> dataURL
      const img = await loadImageFromFile(file);
      const { w, h } = fitBox(img.naturalWidth || img.width, img.naturalHeight || img.height, maxSide);

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d", { alpha: false });

      ctx.drawImage(img, 0, 0, w, h);

      // Converti tutto in JPEG per alleggerire (Telegram va benissimo)
      const dataUrl = canvas.toDataURL("image/jpeg", quality);
      return dataUrl;
    }

    function fitBox(srcW, srcH, maxSide){
      if (!srcW || !srcH) return { w: maxSide, h: maxSide };
      const scale = Math.min(1, maxSide / Math.max(srcW, srcH));
      return { w: Math.round(srcW * scale), h: Math.round(srcH * scale) };
    }

    function loadImageFromFile(file){
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = () => { URL.revokeObjectURL(url); reject(new Error("IMG_LOAD_FAIL")); };
        img.src = url;
      });
    }

    // =========================
    // Send report (save local + worker)
    // =========================
    btnSend.addEventListener("click", async () => {
      const titolo = (elTitolo.value || "").trim();
      const descrizione = (elDescrizione.value || "").trim();
      const anonimo = !!elAnonimo.checked;

      if (!titolo || !descrizione) {
        showBanner("error", "Compila Titolo e Descrizione.", 3500);
        return;
      }

      const now = new Date();

      // salva in locale SEMPRE
      const reports = loadReports();
      const reportItem = {
        id: `${now.getTime()}_${Math.random().toString(16).slice(2)}`,
        titolo,
        descrizione,
        anonimo,
        when: now.toLocaleString("it-IT"),
        // salva solo 1 mini-anteprima per non saturare storage
        thumb: photos[0]?.dataUrl || null,
        photosCount: photos.length
      };
      reports.unshift(reportItem);
      saveReports(reports);

      // prepara UI
      btnSend.disabled = true;
      showBanner("info", "Invio in corso‚Ä¶", 0);

      // payload worker (nuovo)
      const payload = {
        titolo,
        descrizione,
        anonimo,
        when: now.toLocaleString("it-IT"),
        source: "SegnalaFacile PWA",
        photos: photos.map(p => ({
          dataUrl: p.dataUrl,
          name: p.name || "foto.jpg",
          type: p.type || "image/jpeg"
        }))
      };

      let telegramOk = false;
      let telegramMsg = "";

      try{
        const url = new URL(CONFIG.telegramWorkerUrl);
        const res = await fetch(url.toString(), {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Api-Key": CONFIG.telegramApiKey || ""
          },
          body: JSON.stringify(payload)
        });

        const j = await res.json().catch(() => null);

        if (res.ok && j && j.ok) {
          telegramOk = true;
          telegramMsg = "Segnalazione salvata e inoltrata su Telegram ‚úÖ";
          showBanner("success", telegramMsg, 3500);
        } else {
          const detail = j ? JSON.stringify(j) : "Nessuna risposta JSON";
          telegramOk = false;
          telegramMsg = `Telegram/Worker: errore ${res.status} ¬∑ ${detail}`;
          showBanner("error", telegramMsg, 0);
        }
      } catch (e) {
        telegramOk = false;
        telegramMsg = `Telegram/Worker: errore di rete ¬∑ ${String(e)}`;
        showBanner("error", telegramMsg, 0);
      } finally {
        btnSend.disabled = false;

        // aggiorna schermata success dinamica
        if (telegramOk) {
          successTitle.textContent = "Segnalazione inviata correttamente";
          successHint.textContent = "Salvata in locale e inoltrata su gruppo Telegram Segnala Facile.";
        } else {
          successTitle.textContent = "Segnalazione salvata correttamente";
          successHint.textContent = "Salvata in locale. Telegram non ha inoltrato (nessun dato perso).";
        }

        // reset form (ma lascia banner se errore)
        elTitolo.value = "";
        elDescrizione.value = "";
        elAnonimo.checked = false;
        photos = [];
        renderPhotoPreview();

        location.hash = "#/success";
      }
    });

    // =========================
    // Render list
    // =========================
    const list = document.getElementById("list");
    const emptyState = document.getElementById("emptyState");
    const btnClearAll = document.getElementById("btnClearAll");

    function renderList(){
      const reports = loadReports();
      emptyState.style.display = reports.length ? "none" : "block";

      list.innerHTML = reports.map(r => {
        const t = escapeHtml(r.titolo || "");
        const d = escapeHtml(r.descrizione || "");
        const when = escapeHtml(r.when || "");
        const anon = r.anonimo ? "S√¨" : "No";
        const photosCount = Number(r.photosCount || 0);
        const thumb = r.thumb ? `<img class="thumb" src="${r.thumb}" alt="foto">` : `<div class="thumb"></div>`;

        return `
          <div class="item">
            ${thumb}
            <div style="flex:1">
              <h3>üìå ${t}</h3>
              <p>${d}</p>
              <div class="metaRow">
                <span class="pill">üïí ${when}</span>
                <span class="pill">üï∂Ô∏è Anonimo: ${anon}</span>
                <span class="pill">üì∑ Foto: ${photosCount}</span>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    btnClearAll.addEventListener("click", () => {
      if (!confirm("Vuoi svuotare tutte le segnalazioni salvate in locale?")) return;
      saveReports([]);
      renderList();
      showBanner("info", "Storico svuotato.", 2500);
    });

    // =========================
    // Init
    // =========================
    route();
    renderPhotoPreview();
  </script>
</body>
</html>
