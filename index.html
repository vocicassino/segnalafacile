<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>SegnalaFacile</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#0b1220; --bg2:#070c18; --text:#eaf0ff; --muted:#a9b6db;
      --accent:#2d7dff; --accent2:#19c37d; --danger:#ff4d4f;
      --stroke:rgba(255,255,255,.10); --stroke2:rgba(255,255,255,.16);
      --r:22px; --r2:28px;
      --shadow: 0 18px 45px rgba(0,0,0,.40); --shadow2: 0 10px 25px rgba(0,0,0,.35);
      --glass1: rgba(255,255,255,.08); --glass2: rgba(255,255,255,.04);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(45,125,255,.28), transparent 55%),
        radial-gradient(1100px 700px at 85% 5%, rgba(25,195,125,.20), transparent 60%),
        radial-gradient(900px 650px at 50% 120%, rgba(45,125,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    .wrap{
      max-width: 920px; margin: 0 auto;
      padding: 18px 16px calc(132px + env(safe-area-inset-bottom));
    }

    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 10px 0 12px; }
    .brand{display:flex; align-items:center; gap:14px;}
    .logo{
      width:70px; height:70px; border-radius:22px;
      background: url("icons/icon-192.png") center/cover no-repeat, linear-gradient(135deg, rgba(45,125,255,.95), rgba(25,195,125,.90));
      box-shadow: 0 18px 40px rgba(0,0,0,.45); outline: 1px solid rgba(255,255,255,.10); flex:0 0 auto;
    }
    .title{ font-size: 28px; font-weight: 980; letter-spacing: -.35px; line-height: 1.05; }

    .grid{display:grid; gap:14px; position:relative;}

    .card{
      position:relative;
      background: linear-gradient(145deg, rgba(38,86,108,.85), rgba(12,25,45,.85));
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 28px; padding: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      margin-bottom: 28px; min-height: 60vh;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .card::before{
      content:""; position:absolute; inset:-1px;
      background: radial-gradient(740px 160px at 20% 0%, rgba(45,125,255,.22), transparent 55%),
                  radial-gradient(740px 160px at 85% 0%, rgba(25,195,125,.18), transparent 55%);
      pointer-events:none; opacity:.95; border-radius: 28px;
    }
    .card > *{position:relative}

    .heroTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .heroCover{
      width: 100%; height: 180px; object-fit: cover; border-radius: 24px;
      border: 1px solid rgba(255,255,255,.12); box-shadow: 0 18px 45px rgba(0,0,0,.38);
      display: block; margin: 14px 0 16px; filter: saturate(1.05) contrast(1.02);
    }
    @media (min-width: 520px){ .heroCover{ height: 210px; } }
    .hero h1{ margin:0 0 10px; font-size: 34px; line-height: 1.08; letter-spacing: -.7px; }
    .hero p{ margin:0; color: var(--muted); font-size: 15px; line-height: 1.55; max-width: 62ch; }

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    button, .btn{
      cursor:pointer; border:0; border-radius: 18px; padding: 12px 14px; font-weight: 900; font-size: 14px;
      display:inline-flex; align-items:center; justify-content:center; gap:10px; text-decoration:none;
      color: var(--text); -webkit-tap-highlight-color: transparent; touch-action: manipulation;
      transition: transform .12s ease, filter .12s ease, background .12s ease, border-color .12s ease;
      user-select:none; min-height: 46px;
    }
    button:active, .btn:active{transform: translateY(1px) scale(.99)}
    button:disabled{opacity:.65; cursor:not-allowed; transform:none !important}

    .primary{ background: linear-gradient(135deg, rgba(45,125,255,1), rgba(45,125,255,.70)); box-shadow: 0 18px 36px rgba(45,125,255,.18); }
    .primary:hover{filter: brightness(1.06)}
    .ghost{ background: rgba(255,255,255,.055); border:1px solid var(--stroke); }
    .ghost:hover{border-color: var(--stroke2)}
    .danger{ background: rgba(255,77,79,.14); border:1px solid rgba(255,77,79,.35); }
    .danger:hover{border-color: rgba(255,77,79,.55)}
    .small{padding:10px 12px; border-radius:16px; font-size:13px; min-height:42px}

    .ctaBig{
      width:100%; padding: 16px 16px; border-radius: 22px; font-size: 16px; font-weight: 980; min-height: 56px;
      background: linear-gradient(135deg, rgba(45,125,255,1), rgba(45,125,255,.62));
      box-shadow: 0 22px 44px rgba(45,125,255,.20); position:relative; overflow:hidden;
    }
    .ctaBig::after{
      content:""; position:absolute; inset:-40%;
      background: radial-gradient(circle at 20% 40%, rgba(255,255,255,.22), transparent 42%),
                  radial-gradient(circle at 80% 60%, rgba(25,195,125,.16), transparent 46%);
      transform: rotate(12deg); opacity:.8; pointer-events:none;
    }
    .ctaBig .dot{
      width: 10px; height: 10px; border-radius: 999px; background: rgba(255,255,255,.9);
      box-shadow: 0 0 0 6px rgba(255,255,255,.12); z-index:1;
    }
    .ctaBig span, .ctaBig .dot{position:relative}
    .ctaBig:hover{filter: brightness(1.06)}

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row > *{flex:1 1 220px}

    label{ display:block; font-size: 12px; color: var(--muted); margin: 12px 0 7px; font-weight: 850; letter-spacing: .25px; }

    input[type="text"], input[type="email"], input[type="tel"], textarea, select{
      width:100%; padding: 12px 12px; border-radius: 18px; border: 1px solid var(--stroke);
      background: rgba(0,0,0,.22); color: var(--text); outline:none; transition: border-color .12s ease, box-shadow .12s ease;
    }
    input:focus, textarea:focus, select:focus{ border-color: rgba(45,125,255,.55); box-shadow: 0 0 0 3px rgba(45,125,255,.16); }
    textarea{min-height:120px; resize:vertical}
    select option { background: var(--bg2); color: var(--text); }

    .hint{ font-size:12.5px; color: var(--muted); margin-top:10px; line-height:1.5; }

    .toggle{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 12px; border-radius: 20px; border:1px solid var(--stroke);
      background: rgba(0,0,0,.18); margin-top: 12px;
    }
    .toggle span{color:var(--muted); font-size:13px}
    .toggle strong{font-size:13px; font-weight:980}
    .toggle input{transform: scale(1.15)}

    .contactBox{ margin-top: 12px; padding: 12px; border-radius: 22px; border: 1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.16); }
    .contactTitle{ font-weight: 980; letter-spacing: .2px; margin: 0 0 6px; display:flex; align-items:center; gap:10px; }
    .contactGrid{ display:grid; gap:10px; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (max-width: 640px){ .contactGrid{grid-template-columns: 1fr;} }

    .preview{
      margin-top: 12px; display:none; gap: 12px; align-items:flex-start; padding: 12px;
      border-radius: 22px; border:1px dashed rgba(255,255,255,.18); background: rgba(0,0,0,.16);
    }
    .thumbs{ display:flex; flex-wrap:wrap; gap:8px; align-items:flex-start; padding:2px; }
    .thumbs img{
      width:76px; height:76px; object-fit:cover; border-radius:18px;
      border:1px solid var(--stroke); background:rgba(255,255,255,.05); box-shadow: 0 10px 18px rgba(0,0,0,.30);
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px; padding: 8px 12px; border-radius: 999px;
      background: rgba(255,255,255,.06); border: 1px solid var(--stroke); color: var(--text);
      font-size: 12px; font-weight: 900; box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }

    .list{display:grid; gap:10px; margin-top:12px}
    .item{
      padding: 14px; border-radius: 22px; background: rgba(0,0,0,.18); border: 1px solid var(--stroke);
      display:flex; flex-direction:column; gap:12px; transition: border-color .12s ease, transform .12s ease;
    }
    .item.highlight { border-color: var(--accent); box-shadow: 0 0 15px rgba(45,125,255,0.3); }
    .item-top { display:flex; gap:12px; align-items:flex-start; }
    .item:hover{border-color: var(--stroke2)}
    .thumb{
      width: 78px; height: 78px; border-radius: 22px; border: 1px solid var(--stroke);
      object-fit: cover; background: rgba(255,255,255,.05); box-shadow: 0 10px 18px rgba(0,0,0,.28);
    }
    .item h3{margin:0; font-size:16px; font-weight:950}
    .item p{margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.45}
    .metaRow{margin-top:8px; display:flex; flex-wrap:wrap; gap:8px}

    /* NUOVO: Griglia foto interna allo storico */
    .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 10px; }
    .gallery-img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 1px solid var(--stroke); cursor: pointer; }

    .hidden{display:none !important}
    section{display:none} section:not(.hidden){display:block}

    .ok{ display:flex; align-items:center; gap:12px; padding: 14px; border-radius: 22px; border: 1px solid rgba(25,195,125,.35); background: rgba(25,195,125,.12); }
    .banner{
      position: sticky; top: 10px; z-index: 2000; display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding: 12px 12px; border-radius: 22px; border:1px solid var(--stroke); background: rgba(255,255,255,.06);
      backdrop-filter: blur(12px); box-shadow: var(--shadow2); margin: 0 0 12px;
    }
    .banner .text{font-size:13px; line-height:1.35; color:var(--text)}
    .banner .close{ flex:0 0 auto; border:1px solid var(--stroke); background: rgba(0,0,0,.20); color: var(--text); border-radius: 16px; padding: 8px 10px; font-weight: 950; }
    .banner.info{border-color: rgba(45,125,255,.35); background: rgba(45,125,255,.10)}
    .banner.success{border-color: rgba(25,195,125,.35); background: rgba(25,195,125,.12)}
    .banner.error{border-color: rgba(255,77,79,.35); background: rgba(255,77,79,.12)}

    .progressWrap{ margin-top: 12px; padding: 12px; border-radius: 22px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.16); display:none; }
    .progressTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 10px; }
    .progressTitle{ font-weight: 980; letter-spacing: .2px; display:flex; align-items:center; gap:10px; }
    .stepPill{ font-size: 12px; font-weight: 950; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color: var(--text); white-space: nowrap; }
    .bar{ height: 10px; border-radius: 999px; background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); overflow:hidden; }
    .bar > span{ display:block; height:100%; width: 0%; background: linear-gradient(90deg, rgba(45,125,255,1), rgba(25,195,125,1)); transition: width .25s ease; }
    .progressHint{ margin-top: 10px; font-size: 12.5px; color: var(--muted); line-height: 1.45; }

    .emptyState{ text-align:center; opacity:.85; margin-top:40px; }
    .emptyIcon{ font-size:48px; margin-bottom:10px; }
    .contactInfo{ margin: 8px 2px 0; opacity:.75; font-size:14px; text-align:left; }

    /* MAP UI */
    .mapShell{
      margin-top: 14px; border-radius: 24px; border: 1px solid rgba(255,255,255,.12); overflow:hidden;
      background: rgba(0,0,0,.16); box-shadow: 0 18px 45px rgba(0,0,0,.32);
    }
    .mapTopBar{
      display:flex; justify-content:space-between; align-items:center; gap:10px; padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04);
    }
    .mapTitle{ font-weight: 980; letter-spacing: .2px; }
    .mapHint{ font-size:12.5px; color: var(--muted); margin: 6px 0 0; line-height: 1.35; }
    .mapBox{ width:100%; height: 320px; }
    .mapBox.big{ height: 520px; }
    @media (max-width: 420px){ .mapBox.big{ height: 460px; } }

    /* Modals */
    .modalOverlay{
      position: fixed; inset: 0; background: rgba(0,0,0,.55); backdrop-filter: blur(8px);
      display:none; align-items:flex-end; justify-content:center; z-index: 99999; padding: 14px;
    }
    .modal{
      width: min(920px, 100%); background: linear-gradient(145deg, rgba(38,86,108,.92), rgba(12,25,45,.92));
      border: 1px solid rgba(255,255,255,.14); border-radius: 28px; box-shadow: 0 28px 80px rgba(0,0,0,.55);
      padding: 16px; position:relative; overflow:hidden;
    }
    .modalHeader{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; margin-bottom: 10px; }
    .modalHeader h3{ margin:0; font-size:16px; font-weight: 980; letter-spacing: -.2px; }
    .modalClose{
      border:1px solid rgba(255,255,255,.16); background: rgba(0,0,0,.20); color: var(--text);
      border-radius: 16px; padding: 8px 10px; font-weight: 950; min-height: 40px;
    }
    .mapPickerBox{ width:100%; height: 380px; border-radius: 22px; overflow:hidden; border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.16); margin-top: 10px; }

    /* Leaflet stile */
    .leaflet-container{ background: rgba(0,0,0,.18); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .leaflet-control-zoom a{ background: rgba(10,16,32,.75) !important; color: var(--text) !important; border: 1px solid rgba(255,255,255,.12) !important; backdrop-filter: blur(10px); }
    .leaflet-popup-content-wrapper{ background: rgba(10,16,32,.92); color: var(--text); border: 1px solid rgba(255,255,255,.12); box-shadow: 0 18px 50px rgba(0,0,0,.55); border-radius: 18px; backdrop-filter: blur(10px); }
    .leaflet-popup-tip{ background: rgba(10,16,32,.92); }

    /* DOCK PREMIUM */
    nav.bottom{ position: fixed; left: 0; right: 0; bottom: 0; z-index: 9999; padding: 10px 12px 12px; background: transparent; }
    nav .inner{
      max-width: 560px; margin: 0 auto; display:flex; justify-content:space-between; gap: 10px;
      padding: 10px 10px; border-radius: 28px;
      background: radial-gradient(240px 120px at 20% 10%, rgba(45,125,255,.22), transparent 60%), radial-gradient(240px 120px at 80% 10%, rgba(25,195,125,.18), transparent 60%), rgba(9,14,28,.72);
      border: 1px solid rgba(255,255,255,.12); box-shadow: 0 18px 50px rgba(0,0,0,.55); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); position:relative; overflow:hidden;
    }
    nav .inner::before{
      content:""; position:absolute; inset:-1px; border-radius: 28px; pointer-events:none;
      background: linear-gradient(135deg, rgba(45,125,255,.30), rgba(25,195,125,.22), rgba(255,255,255,.06));
      opacity:.55; mask: linear-gradient(#000, #000) content-box, linear-gradient(#000, #000); -webkit-mask: linear-gradient(#000, #000) content-box, linear-gradient(#000, #000); padding:1px;
    }
    nav a{
      flex: 1; text-align:center; text-decoration:none; color: rgba(169,182,219,.92); font-size: 12px;
      padding: 10px 6px; border-radius: 22px; border: 1px solid transparent; transition: background .16s ease, border-color .16s ease, transform .16s ease, color .16s ease;
      display:flex; flex-direction:column; align-items:center; gap:6px; font-weight: 950; position:relative; overflow:hidden; min-height: 62px;
    }
    .navIco{ width: 28px; height: 28px; display:block; fill: currentColor; opacity: .98; transform: translateZ(0); }
    nav a:active{transform: translateY(1px)}
    nav a.active{ color: var(--text); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.14); }
    nav a.active::before{
      content:""; position:absolute; inset:-30%;
      background: radial-gradient(circle at 50% 35%, rgba(45,125,255,.40), transparent 45%), radial-gradient(circle at 50% 80%, rgba(25,195,125,.22), transparent 55%);
      opacity:.65; pointer-events:none; transform: translateY(-6px);
    }
    nav a.active::after{
      content:""; position:absolute; bottom:8px; width: 8px; height: 8px; border-radius: 999px;
      background: rgba(255,255,255,.92); box-shadow: 0 0 0 6px rgba(45,125,255,.14); opacity:.95;
    }

    @media (prefers-reduced-motion: no-preference){
      nav a.active .navIco{ animation: navPulse 1.9s ease-in-out infinite; }
      @keyframes navPulse{
        0%   { transform: translateY(0) scale(1); filter: drop-shadow(0 0 0 rgba(45,125,255,0)); }
        45%  { transform: translateY(-1px) scale(1.05); filter: drop-shadow(0 10px 18px rgba(45,125,255,.18)); }
        100% { transform: translateY(0) scale(1); filter: drop-shadow(0 0 0 rgba(45,125,255,0)); }
      }
      .card{animation: pop .18s ease both}
      @keyframes pop{ from{transform: translateY(8px); opacity:0} to{transform: translateY(0); opacity:1} }
    }

    /* Docs preview */
    .docsList{ display:grid; gap:8px; margin-top:10px; }
    .docItem{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 10px 12px; border-radius: 18px; border:1px solid var(--stroke); background: rgba(0,0,0,.14); }
    .docItem .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .docBadge{ width: 42px; height: 42px; border-radius: 16px; display:grid; place-items:center; font-weight: 980; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); flex:0 0 auto; }
    .docMeta{min-width:0}
    .docName{ font-weight: 950; font-size: 13px; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; max-width: 54vw; }
    .docSize{ font-size: 12px; color: var(--muted); margin-top:2px; }

    .metaCol{ display:flex; flex-direction:column; gap:8px; min-width:170px; }
    @media (max-width: 520px){
      .metaCol{ min-width:0; width:100%; }
      .preview{ flex-direction:column; align-items:stretch; }
      .thumbs{ justify-content:flex-start; overflow-x:auto; flex-wrap:nowrap; -webkit-overflow-scrolling:touch; padding-bottom:6px; }
      .thumb{ flex:0 0 auto; }
      .row{ flex-wrap:wrap; }
      .row > .btn{ flex:1 1 100%; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div><div class="title">SegnalaFacile</div></div>
      </div>
      <button class="pill" id="installPill" style="display:none; cursor:pointer;" type="button">â¬‡ï¸ Installa</button>
    </header>

    <div id="banner" class="banner hidden" role="status" aria-live="polite">
      <div class="text" id="bannerText"></div>
      <button class="close" id="bannerClose" type="button">âœ•</button>
    </div>

    <section id="view-home" class="grid">
      <div class="card hero">
        <div class="heroTop">
          <div>
            <h1>Segnala subito.</h1>
            <p>Descrivi cosa succede, aggiungi le foto e invia. Il tuo storico resta sul dispositivo.</p>
          </div>
          <img class="heroCover" src="icons/hero.jpg" alt="SegnalaFacile" loading="lazy">
        </div>

        <div class="btnRow">
          <a class="btn ctaBig" href="#/report"><span class="dot"></span> Invia segnalazione</a>
        </div>

        <div class="btnRow">
          <a class="btn ghost" href="#/my">ğŸ—‚ï¸ Le mie segnalazioni</a>
          <a class="btn ghost" href="#/map">ğŸ—ºï¸ Mappa</a>
          <a class="btn ghost" href="#/contacts">â˜ï¸ Contatti</a>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
          <div>
            <div style="font-weight:980;margin-bottom:4px">Come funziona</div>
            <div class="hint" style="margin:0">Compili â€¢ Aggiungi foto â€¢ Invi â€¢ Ti resta lo storico</div>
          </div>
          <a class="btn small ghost" href="#/report">Vai â†’</a>
        </div>

        <div class="mapShell" style="margin-top:14px">
          <div class="mapTopBar">
            <div>
              <div class="mapTitle">Mappa segnalazioni</div>
              <div class="mapHint">Mostra i punti salvati sul dispositivo (PIN cliccabili).</div>
            </div>
            <a class="btn small ghost" href="#/map">Apri</a>
          </div>
          <div id="mapHome" class="mapBox"></div>
        </div>
      </div>
    </section>

    <section id="view-report" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:980;font-size:18px">Nuova segnalazione</div>
            <div class="hint" style="margin:6px 0 0">Compila i campi e premi â€œInviaâ€.</div>
          </div>
          <a class="btn small ghost" href="#/">â† Home</a>
        </div>

        <label for="titolo">Titolo</label>
        <input id="titolo" type="text" maxlength="80" placeholder="Es. Lampione spento in viaâ€¦" />

        <label for="categoria">Categoria</label>
        <select id="categoria">
          <option value="verde">ğŸŒ³ Verde Pubblico</option>
          <option value="strade">ğŸ›£ï¸ Strade e Marciapiedi</option>
          <option value="rifiuti">ğŸ—‘ï¸ Rifiuti/Decoro</option>
          <option value="luce">ğŸ’¡ Illuminazione</option>
          <option value="altro">â“ Altro</option>
        </select>

        <label for="descrizione">Descrizione</label>
        <textarea id="descrizione" maxlength="700" placeholder="Spiega cosa succede, dove e quandoâ€¦"></textarea>

        <label>Posizione (opzionale)</label>
        <div class="row">
          <button class="ghost" id="btnGeoOnce" type="button">ğŸ“ Usa posizione attuale</button>
          <button class="ghost" id="btnGeoLive" type="button">ğŸ›°ï¸ Posizione in tempo reale: OFF</button>
          <button class="ghost" id="btnGeoPick" type="button">ğŸ—ºï¸ Inserisci a mano sulla mappa</button>
          <button class="ghost" id="btnGeoClear" type="button">ğŸ§¹ Rimuovi posizione</button>
        </div>
        <div id="geoLine" class="hint" style="margin-top:10px; display:none;"></div>

        <label>Foto (opzionale)</label>
        <div class="row">
          <button class="ghost" id="btnPickCamera" type="button">ğŸ“· Scatta foto</button>
          <button class="ghost" id="btnPickGallery" type="button">ğŸ–¼ï¸ Scegli dalla galleria</button>
          <input id="fotoCamera" type="file" accept="image/*" capture="environment" class="hidden" />
          <input id="fotoGallery" type="file" accept="image/*" multiple class="hidden" />
          <button class="danger" id="btnClearPhoto" type="button">ğŸ§¹ Rimuovi</button>
        </div>

        <div id="photoPreview" class="preview">
          <div class="metaCol">
            <div style="font-weight:980;color:var(--text)">Anteprima foto</div>
            <div id="photoMeta" class="hint" style="margin:0"></div>
          </div>
          <div class="thumbs" id="thumbs"></div>
        </div>
        
        <label>Documenti (PDF/Word - opzionale)</label>
        <div class="row">
          <button class="ghost" id="btnPickDocs" type="button">ğŸ“ Aggiungi documenti</button>
          <input id="docsInput" type="file" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" multiple class="hidden" />
          <button class="danger" id="btnClearDocs" type="button">ğŸ§¹ Rimuovi documenti</button>
        </div>

        <div id="docsPreview" class="preview">
          <div class="metaCol">
            <div style="font-weight:980;color:var(--text)">Allegati</div>
            <div id="docsMeta" class="hint" style="margin:0"></div>
          </div>
          <div class="docsList" id="docsList"></div>
        </div>

        <div class="toggle">
          <div>
            <strong>Invia anche in forma anonima</strong><br>
            <span>Se disattivi, puoi lasciare un contatto per essere richiamato</span>
          </div>
          <input id="anonimo" type="checkbox" />
        </div>

        <div id="contactBox" class="contactBox hidden">
          <div class="contactTitle">ğŸ“Œ Dati per essere contattato</div>
          <div class="hint" style="margin:0 0 10px">Inserisci almeno <b>Email</b> o <b>Telefono</b>.</div>
          <div class="contactGrid">
            <div>
              <label for="contactName">Nome e Cognome (opzionale)</label>
              <input id="contactName" type="text" maxlength="80" placeholder="Es. Mario Rossi" />
            </div>
            <div>
              <label for="contactPhone">Telefono (opzionale)</label>
              <input id="contactPhone" type="tel" maxlength="30" placeholder="Es. 333 123 4567" />
            </div>
            <div style="grid-column: 1 / -1;">
              <label for="contactEmail">Email (opzionale)</label>
              <input id="contactEmail" type="email" maxlength="120" placeholder="Es. nome@email.it" />
            </div>
          </div>
        </div>

        <div id="progressWrap" class="progressWrap">
          <div class="progressTop">
            <div class="progressTitle">ğŸš€ Invio in corsoâ€¦</div>
            <div class="stepPill" id="progressStep">1/3</div>
          </div>
          <div class="bar"><span id="progressBar"></span></div>
          <div class="progressHint" id="progressHint">Preparazioneâ€¦</div>
        </div>

        <div class="btnRow">
          <button class="primary" id="btnSend" type="button">âœ… Invia</button>
          <a class="btn ghost" href="#/my">ğŸ—‚ï¸ Vedi storico</a>
        </div>
        <div class="hint">La segnalazione viene salvata sul dispositivo.</div>
      </div>
    </section>

    <section id="view-success" class="grid hidden">
      <div class="card">
        <div class="ok">
          <div style="font-size:22px">âœ…</div>
          <div>
            <div style="font-weight:980;font-size:18px">Segnalazione inviata correttamente</div>
            <div class="hint" style="margin:6px 0 0">Salvata in locale. Grazie.</div>
          </div>
        </div>
        <div class="btnRow" style="margin-top:14px">
          <a class="btn primary" href="#/">ğŸ  Torna alla Home</a>
          <a class="btn ghost" href="#/my">ğŸ—‚ï¸ Le mie segnalazioni</a>
          <a class="btn ghost" href="#/report">â• Nuova segnalazione</a>
          <a class="btn ghost" href="#/map">ğŸ—ºï¸ Mappa</a>
        </div>
        <div class="contactInfo">Risposta garantita nel minor tempo possibile.</div>
      </div>
    </section>

    <section id="view-my" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:980;font-size:18px">Le mie segnalazioni</div>
            <div class="hint" style="margin:6px 0 0">Salvate nel database locale del dispositivo.</div>
          </div>
          <div class="row" style="flex:0 0 auto">
            <a class="btn small ghost" href="#/report">â• Nuova</a>
            <button class="btn small danger" id="btnClearAll" type="button">ğŸ—‘ï¸ Svuota Tutto</button>
          </div>
        </div>

        <div id="emptyState" class="hint" style="margin-top:12px">
          <div class="emptyState">
            <div class="emptyIcon">ğŸ“‚</div>
            <h3 style="margin:0 0 6px">Nessuna segnalazione</h3>
            <p style="margin:0;color:var(--muted)">Quando invii una segnalazione, la troverai qui.</p>
          </div>
        </div>

        <div id="list" class="list"></div>
        <div class="contactInfo">Risposta garantita nel minor tempo possibile.</div>
      </div>
    </section>

    <section id="view-map" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:980;font-size:18px">Mappa segnalazioni</div>
            <div class="hint" style="margin:6px 0 0">PIN colorati per categoria. Clicca per i dettagli.</div>
          </div>
          <a class="btn small ghost" href="#/">â† Home</a>
        </div>
        <div class="mapShell" style="margin-top:14px">
          <div class="mapTopBar">
            <div>
              <div class="mapTitle">Tutti i punti</div>
              <div class="mapHint">Visibili solo le segnalazioni con posizione salvata.</div>
            </div>
            <div class="row" style="flex:0 0 auto">
              <button class="btn small ghost" id="btnMapFit" type="button">ğŸ¯ Inquadra Tutto</button>
            </div>
          </div>
          <div id="mapMain" class="mapBox big"></div>
        </div>
        <div class="contactInfo">Risposta garantita nel minor tempo possibile.</div>
      </div>
    </section>

    <section id="view-contacts" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:980;font-size:18px">Contatti</div>
            <div class="hint" style="margin:6px 0 0">Per comunicazioni generali.</div>
          </div>
          <a class="btn small ghost" href="#/">â† Home</a>
        </div>
        <div class="btnRow" style="margin-top:14px">
          <a class="btn ghost" id="mailLink" href="#">âœ‰ï¸ Email</a>
          <a class="btn ghost" id="mapLink" href="#" target="_blank" rel="noreferrer">ğŸ“ Posizione Comune</a>
          <a class="btn ghost" href="#/map">ğŸ—ºï¸ Apri Mappa Interattiva</a>
        </div>
        <div class="mapShell" style="margin-top:14px">
          <div class="mapTopBar">
            <div>
              <div class="mapTitle">Ultime segnalazioni sulla mappa</div>
              <div class="mapHint">Tocca un PIN per vedere il dettaglio.</div>
            </div>
          </div>
          <div id="mapContacts" class="mapBox"></div>
        </div>
        <div class="contactInfo">Risposta garantita nel minor tempo possibile.</div>
      </div>
    </section>
  </div>

  <div class="modalOverlay" id="mapPickerOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mapPickerTitle">
      <div class="modalHeader">
        <h3 id="mapPickerTitle">Inserisci la posizione a mano</h3>
        <button class="modalClose" id="mapPickerClose" type="button">âœ•</button>
      </div>
      <div class="hint" style="margin:0">Tocca sulla mappa per piazzare il PIN. Poi premi â€œUsa questa posizioneâ€.</div>
      <div id="mapPicker" class="mapPickerBox"></div>
      <div class="btnRow" style="margin-top:12px">
        <button class="btn primary" id="btnUsePicked" type="button">âœ… Usa questa posizione</button>
        <button class="btn ghost" id="btnCenterCassino" type="button">ğŸ¯ Centro Cassino</button>
      </div>
      <div class="hint" id="pickedLine" style="margin-top:10px">Nessun punto selezionato.</div>
    </div>
  </div>

  <nav class="bottom" aria-label="Navigazione">
    <div class="inner">
      <a href="#/" data-nav="home" class="active" aria-label="Home">
        <svg class="navIco" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l9 8h-2v10a1 1 0 0 1-1 1h-5v-6H11v6H6a1 1 0 0 1-1-1V11H3l9-8z"/></svg>
        <span>Home</span>
      </a>
      <a href="#/report" data-nav="report" aria-label="Segnala">
        <svg class="navIco" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 4h12a2 2 0 0 1 2 2v14H6a2 2 0 0 0-2 2V4zm4 4h8v2H8V8zm0 4h8v2H8v-2zm0 4h6v2H8v-2z"/>
          <path d="M20 8h2v14a2 2 0 0 1-2 2H8v-2h12V8z"/>
        </svg>
        <span>Segnala</span>
      </a>
      <a href="#/my" data-nav="my" aria-label="Storico">
        <svg class="navIco" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 4h10a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm2 4h6v2H9V8zm0 4h6v2H9v-2zm0 4h4v2H9v-2z"/></svg>
        <span>Storico</span>
      </a>
      <a href="#/map" data-nav="map" aria-label="Mappa">
        <svg class="navIco" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15 5l-6 2-6-2v15l6 2 6-2 6 2V7l-6-2zm0 2.1l4 1.3v11.4l-4-1.3V7.1zM9 7.1l4-1.3v11.4l-4 1.3V7.1zM3 8.4l4 1.3v11.4l-4-1.3V8.4z"/>
        </svg>
        <span>Mappa</span>
      </a>
      <a href="#/contacts" data-nav="contacts" aria-label="Contatti">
        <svg class="navIco" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-4.4 0-8 2-8 4.5V21h16v-2.5C20 16 16.4 14 12 14z"/></svg>
        <span>Contatti</span>
      </a>
    </div>
  </nav>

  <script>
    // =========================
    // CONFIG
    // =========================
    const CONFIG = {
      email: "vocidicassino@proton.me",
      mapsQuery: "Cassino",
      telegramWorkerUrl: "https://segnalafacile-telegram.vocidicassino.workers.dev",
      telegramApiKey: "Marco-Admin-2026",
      sendOnlyFirstPhotoToServer: false
    };

    // =========================
    // INDEXEDDB - Gestione Memoria InfinitÃ 
    // =========================
    let db;
    let localReportsCache = [];

    function initStorage() {
      return new Promise((resolve) => {
        const req = indexedDB.open("SegnalaFacile_v8", 1);
        req.onupgradeneeded = (e) => {
          e.target.result.createObjectStore("reports", { keyPath: "id" });
        };
        req.onsuccess = (e) => {
          db = e.target.result;
          const tx = db.transaction("reports", "readonly");
          const store = tx.objectStore("reports");
          const getReq = store.getAll();
          getReq.onsuccess = () => {
            localReportsCache = getReq.result || [];
            resolve();
          };
          getReq.onerror = () => { localReportsCache = []; resolve(); };
        };
        req.onerror = () => {
          // Fallback a localStorage se IndexedDB fallisce
          try { localReportsCache = JSON.parse(localStorage.getItem("segnalafacile_reports_v7") || "[]"); } 
          catch { localReportsCache = []; }
          resolve();
        };
      });
    }

    function loadReports() { return localReportsCache; }

    function saveReports(arr) {
      localReportsCache = arr;
      if (db) {
        const tx = db.transaction("reports", "readwrite");
        const store = tx.objectStore("reports");
        store.clear();
        arr.forEach(i => store.put(i));
      } else {
        localStorage.setItem("segnalafacile_reports_v7", JSON.stringify(arr));
      }
    }

    // =========================
    // Banner helper
    // =========================
    const banner = document.getElementById("banner");
    const bannerText = document.getElementById("bannerText");
    const bannerClose = document.getElementById("bannerClose");
    let bannerTimer = null;

    function showBanner(type, text, autoHideMs = 0){
      if (bannerTimer) { clearTimeout(bannerTimer); bannerTimer = null; }
      banner.classList.remove("hidden","info","success","error");
      banner.classList.add(type || "info");
      bannerText.textContent = text || "";
      if (autoHideMs && autoHideMs > 0){
        bannerTimer = setTimeout(() => hideBanner(), autoHideMs);
      }
    }
    function hideBanner(){
      if (bannerTimer) { clearTimeout(bannerTimer); bannerTimer = null; }
      banner.classList.add("hidden");
      banner.classList.remove("info","success","error");
      bannerText.textContent = "";
    }
    bannerClose.addEventListener("click", hideBanner);

    // =========================
    // PWA install prompt
    // =========================
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const pill = document.getElementById("installPill");
      pill.style.display = "inline-flex";
      pill.addEventListener("click", async () => {
        try{ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; pill.style.display = "none"; }catch{}
      }, { once:true });
    });

    // =========================
    // Router
    // =========================
    const views = {
      home: document.getElementById("view-home"), report: document.getElementById("view-report"),
      success: document.getElementById("view-success"), my: document.getElementById("view-my"),
      contacts: document.getElementById("view-contacts"), map: document.getElementById("view-map")
    };

    const navLinks = Array.from(document.querySelectorAll("nav a[data-nav]"));
    function setActiveNav(key){ navLinks.forEach(a => a.classList.toggle("active", a.dataset.nav === key)); }

    function showView(key){
      Object.values(views).forEach(v => v.classList.add("hidden"));
      views[key].classList.remove("hidden");
      setActiveNav(key);

      if(key === "my") renderList();
      if(key === "map") { ensureMaps(); refreshAllMaps(); setTimeout(() => { try{ mapMain?.invalidateSize(); }catch{} }, 60); }
      if(key === "home" || key === "contacts"){
        ensureMaps(); refreshAllMaps();
        setTimeout(() => { try{ mapHome?.invalidateSize(); }catch{} }, 60);
        setTimeout(() => { try{ mapContacts?.invalidateSize(); }catch{} }, 60);
      }
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function route(){
      const hash = (location.hash || "#/").replace("#/", "");
      const key = hash || "home";
      if (views[key]) showView(key); else showView("home");
    }
    window.addEventListener("hashchange", route);

    // =========================
    // Contacts (Email + Mappa)
    // =========================
    function applyContacts(){
      const subject = "Messaggio da SegnalaFacile";
      const body = "Ciao,%0D%0A%0D%0AScrivo da SegnalaFacile:%0D%0A";
      document.getElementById("mailLink").href = `mailto:${CONFIG.email}?subject=${encodeURIComponent(subject)}&body=${body}`;
      document.getElementById("mapLink").href = `https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(CONFIG.mapsQuery)}`;
    }
    applyContacts();

    // =========================
    // Form + multi-photo + GEO
    // =========================
    const elTitolo = document.getElementById("titolo");
    const elCategoria = document.getElementById("categoria");
    const elDescrizione = document.getElementById("descrizione");
    const elAnonimo = document.getElementById("anonimo");

    const elContactBox = document.getElementById("contactBox");
    const elContactName = document.getElementById("contactName");
    const elContactPhone = document.getElementById("contactPhone");
    const elContactEmail = document.getElementById("contactEmail");

    const elFotoCamera = document.getElementById("fotoCamera");
    const elFotoGallery = document.getElementById("fotoGallery");
    const elDocsInput = document.getElementById("docsInput");

    const btnPickCamera = document.getElementById("btnPickCamera");
    const btnPickGallery = document.getElementById("btnPickGallery");
    const btnPickDocs = document.getElementById("btnPickDocs");

    const btnClearPhoto = document.getElementById("btnClearPhoto");
    const btnClearDocs = document.getElementById("btnClearDocs");
    const btnSend = document.getElementById("btnSend");

    const preview = document.getElementById("photoPreview");
    const photoMeta = document.getElementById("photoMeta");
    const thumbs = document.getElementById("thumbs");
    
    const docsPreview = document.getElementById("docsPreview");
    const docsMeta = document.getElementById("docsMeta");
    const docsList = document.getElementById("docsList");

    // GEO UI
    const btnGeoOnce = document.getElementById("btnGeoOnce");
    const btnGeoLive = document.getElementById("btnGeoLive");
    const btnGeoPick = document.getElementById("btnGeoPick");
    const btnGeoClear = document.getElementById("btnGeoClear");
    const geoLine = document.getElementById("geoLine");

    let geo = null; let geoWatchId = null; let geoLiveOn = false;
    let photos = []; let documents = []; 

    function renderGeo(){
      if(!geo){ geoLine.style.display = "none"; geoLine.textContent = ""; return; }
      const modeLabel = geo.mode === "live" ? "LIVE" : geo.mode === "pick" ? "MAPPA" : "GPS";
      geoLine.style.display = "block";
      geoLine.textContent = `ğŸ“ Posizione (${modeLabel}): ${geo.lat.toFixed(6)}, ${geo.lng.toFixed(6)}`;
    }

    function setGeoFromPosition(pos, mode){
      geo = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy || 0, mode: mode || "gps" };
      renderGeo(); refreshAllMaps();
    }

    function stopLive(){
      if(geoWatchId !== null){ try{ navigator.geolocation.clearWatch(geoWatchId); }catch{} }
      geoWatchId = null; geoLiveOn = false; btnGeoLive.textContent = "ğŸ›°ï¸ Posizione in tempo reale: OFF";
    }

    btnGeoOnce?.addEventListener("click", async () => {
      if(!navigator.geolocation){ showBanner("error", "GPS non supportato.", 4500); return; }
      showBanner("info", "Recupero posizioneâ€¦");
      navigator.geolocation.getCurrentPosition(
        (pos) => { setGeoFromPosition(pos, "gps"); hideBanner(); showBanner("success", "Posizione acquisita âœ…", 2200); },
        (err) => { showBanner("error", "Posizione non disponibile (GPS spento).", 5500); },
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 15000 }
      );
    });

    btnGeoLive?.addEventListener("click", async () => {
      if(!navigator.geolocation) return;
      if(!geoLiveOn){
        showBanner("info", "Attivo posizione in tempo realeâ€¦");
        geoLiveOn = true; btnGeoLive.textContent = "ğŸ›°ï¸ Posizione in tempo reale: ON";
        geoWatchId = navigator.geolocation.watchPosition(
          (pos) => { setGeoFromPosition(pos, "live"); hideBanner(); },
          (err) => { showBanner("error", "LIVE non disponibile.", 5500); stopLive(); },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      } else { stopLive(); showBanner("info", "Posizione in tempo reale disattivata.", 2200); }
    });

    btnGeoClear?.addEventListener("click", () => { stopLive(); geo = null; renderGeo(); showBanner("info", "Posizione rimossa.", 2000); refreshAllMaps(); });

    // MAP PICKER modal
    const mapPickerOverlay = document.getElementById("mapPickerOverlay");
    const mapPickerClose = document.getElementById("mapPickerClose");
    const btnUsePicked = document.getElementById("btnUsePicked");
    const btnCenterCassino = document.getElementById("btnCenterCassino");
    const pickedLine = document.getElementById("pickedLine");

    let mapPicker = null; let picked = null; let pickedMarker = null;

    function openMapPicker(){
      mapPickerOverlay.style.display = "flex"; mapPickerOverlay.setAttribute("aria-hidden","false");
      if(!mapPicker){
        mapPicker = L.map("mapPicker", { zoomControl:true }).setView([41.492, 13.831], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(mapPicker);
        mapPicker.on("click", (e) => {
          picked = { lat: e.latlng.lat, lng: e.latlng.lng };
          pickedLine.textContent = `Punto selezionato: ${picked.lat.toFixed(6)}, ${picked.lng.toFixed(6)}`;
          if(pickedMarker) pickedMarker.remove();
          pickedMarker = L.marker([picked.lat, picked.lng], { riseOnHover:true }).addTo(mapPicker);
          pickedMarker.bindPopup("Posizione selezionata").openPopup();
        });
      }
      setTimeout(() => { try{ mapPicker.invalidateSize(); }catch{} }, 80);
    }
    function closeMapPicker(){ mapPickerOverlay.style.display = "none"; mapPickerOverlay.setAttribute("aria-hidden","true"); }

    btnGeoPick?.addEventListener("click", openMapPicker);
    mapPickerClose?.addEventListener("click", closeMapPicker);
    btnCenterCassino?.addEventListener("click", () => { if(mapPicker) mapPicker.setView([41.492, 13.831], 13); });
    btnUsePicked?.addEventListener("click", () => {
      if(!picked){ showBanner("error", "Prima seleziona un punto sulla mappa.", 3500); return; }
      stopLive(); geo = { lat: picked.lat, lng: picked.lng, acc: 0, mode: "pick" };
      renderGeo(); refreshAllMaps(); showBanner("success", "Posizione inserita âœ…", 2500); closeMapPicker();
    });

    function toggleContactBox(){ elContactBox.classList.toggle("hidden", !!elAnonimo.checked); }
    elAnonimo.addEventListener("change", toggleContactBox); toggleContactBox();

    btnPickCamera.addEventListener("click", () => elFotoCamera.click());
    btnPickGallery.addEventListener("click", () => elFotoGallery.click());
    btnPickDocs.addEventListener("click", () => elDocsInput.click());

    btnClearPhoto.addEventListener("click", () => { elFotoCamera.value = ""; elFotoGallery.value = ""; photos = []; renderPhotoPreview(); showBanner("info", "Foto rimosse.", 1800); });
    btnClearDocs.addEventListener("click", () => { elDocsInput.value = ""; documents = []; renderDocsPreview(); showBanner("info", "Documenti rimossi.", 1800); });

    function formatBytes(bytes){
      if (!bytes && bytes !== 0) return "";
      const units = ["B","KB","MB","GB"]; let i = 0, n = bytes;
      while(n >= 1024 && i < units.length-1){ n /= 1024; i++; }
      return `${n.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
    }

    async function fileToCompressedJpegDataUrl(file){
      const img = await new Promise((resolve, reject) => {
        const i = new Image(); i.onload = () => resolve(i); i.onerror = reject; i.src = URL.createObjectURL(file);
      });
      const maxSide = 1400; let w = img.naturalWidth, h = img.naturalHeight;
      const ratio = Math.min(1, maxSide / Math.max(w,h)); w = Math.round(w * ratio); h = Math.round(h * ratio);
      const canvas = document.createElement("canvas"); canvas.width = w; canvas.height = h;
      canvas.getContext("2d").drawImage(img, 0, 0, w, h);
      const dataUrl = canvas.toDataURL("image/jpeg", 0.82);
      const blob = await (await fetch(dataUrl)).blob();
      return { dataUrl, blob };
    }

    function renderPhotoPreview(){
      thumbs.innerHTML = "";
      if(!photos.length){ preview.style.display = "none"; photoMeta.textContent = ""; return; }
      preview.style.display = "flex";
      photoMeta.textContent = `${photos.length} foto selezionate â€¢ ${formatBytes(photos.reduce((s,p) => s + (p.blobSize || 0), 0))}`;
      photos.forEach(p => { const im = document.createElement("img"); im.src = p.dataUrl; thumbs.appendChild(im); });
    }

    async function addFiles(fileList, replace = false){
      const files = Array.from(fileList || []).filter(Boolean);
      if(!files.length) return;
      if(replace) photos = [];
      const MAX = 6; const pickedFiles = files.slice(0, Math.max(0, MAX - photos.length));
      for(const f of pickedFiles){
        const { dataUrl, blob } = await fileToCompressedJpegDataUrl(f);
        photos.push({ dataUrl, name: f.name || "foto.jpg", type: f.type || "image/jpeg", blobSize: blob.size });
      }
      renderPhotoPreview();
    }
    elFotoCamera.addEventListener("change", async (e) => await addFiles(e.target.files, true));
    elFotoGallery.addEventListener("change", async (e) => await addFiles(e.target.files, false));

    function docKindBadge(type, name){
      const n = (name || "").toLowerCase(), t = (type || "").toLowerCase();
      if (t.includes("pdf") || n.endsWith(".pdf")) return "PDF";
      if (t.includes("word") || n.endsWith(".doc") || n.endsWith(".docx")) return "DOC";
      return "FILE";
    }

    function renderDocsPreview(){
      docsList.innerHTML = "";
      if(!documents.length){ docsPreview.style.display = "none"; docsMeta.textContent = ""; return; }
      docsPreview.style.display = "flex";
      docsMeta.textContent = `${documents.length} documento/i â€¢ ${formatBytes(documents.reduce((s,d) => s + (d.blobSize || 0), 0))}`;
      documents.forEach(d => {
        const item = document.createElement("div"); item.className = "docItem";
        item.innerHTML = `<div class="left"><div class="docBadge">${docKindBadge(d.type, d.name)}</div><div class="docMeta"><div class="docName">${d.name}</div><div class="docSize">${formatBytes(d.blobSize)}</div></div></div>`;
        docsList.append(item);
      });
    }

    async function addDocs(fileList){
      const files = Array.from(fileList || []).filter(Boolean);
      for(const f of files.slice(0, 3 - documents.length)){
        if((f.size || 0)/(1024*1024) > 6){ showBanner("error", `Documento troppo grande: ${f.name}`); continue; }
        const r = new FileReader();
        r.onload = () => { documents.push({ dataUrl: String(r.result), name: f.name, type: f.type, blobSize: f.size }); renderDocsPreview(); };
        r.readAsDataURL(f);
      }
    }
    elDocsInput.addEventListener("change", async (e) => await addDocs(e.target.files));

    // Progress UI
    const progressWrap = document.getElementById("progressWrap");
    const progressStep = document.getElementById("progressStep");
    const progressBar = document.getElementById("progressBar");
    const progressHint = document.getElementById("progressHint");
    function showProgress(step, hint){ progressWrap.style.display = "block"; progressStep.textContent = `${step}/3`; progressHint.textContent = hint || ""; progressBar.style.width = (step === 1 ? 33 : step === 2 ? 66 : 100) + "%"; }
    function hideProgress(){ progressWrap.style.display = "none"; progressBar.style.width = "0%"; }

    btnSend.addEventListener("click", async () => {
      const titolo = (elTitolo.value || "").trim(); const descrizione = (elDescrizione.value || "").trim();
      if(titolo.length < 4 || descrizione.length < 10){ showBanner("error", "Compila correttamente Titolo e Descrizione."); return; }
      
      const isAnon = !!elAnonimo.checked;
      if(!isAnon && !(elContactEmail.value || elContactPhone.value.length >= 6)){ showBanner("error", "Se NON anonimo, inserisci Email o Telefono."); return; }

      btnSend.disabled = true; showProgress(1, "Preparazione datiâ€¦");
      
      const payload = {
        titolo, descrizione, anonimo: isAnon, categoria: elCategoria.value,
        when: new Date().toLocaleString("it-IT"),
        geo: geo ? { lat: geo.lat, lng: geo.lng, acc: geo.acc, mode: geo.mode } : null,
        photos: photos.map(p => ({ dataUrl: p.dataUrl, name: p.name, type: p.type })),
        documents: documents.map(d => ({ dataUrl: d.dataUrl, name: d.name, type: d.type })),
        sender_contact: isAnon ? "Anonimo" : `ğŸ‘¤ ${elContactName.value} â€¢ ğŸ“ ${elContactPhone.value} â€¢ âœ‰ï¸ ${elContactEmail.value}`
      };

      // Salvataggio Database Locale (IndexedDB)
      const arr = loadReports();
      arr.push({ id: String(Date.now()), ...payload, photoDataUrl: photos[0]?.dataUrl }); 
      saveReports(arr); refreshAllMaps();

      try{
        showProgress(2, "Invio a Telegramâ€¦");
        const res = await fetch(CONFIG.telegramWorkerUrl, { method: "POST", headers: { "Content-Type": "application/json", "X-Api-Key": CONFIG.telegramApiKey }, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error("Errore Server");
        showProgress(3, "Completato!");
        setTimeout(() => {
          hideProgress(); location.hash = "#/success";
          elTitolo.value = ""; elDescrizione.value = ""; elFotoCamera.value = ""; photos = []; renderPhotoPreview();
        }, 500);
      }catch(e){
        hideProgress(); showBanner("error", "Offline: Segnalazione salvata ma non inviata al server.", 4000);
        location.hash = "#/my";
      }finally{ btnSend.disabled = false; }
    });

    // =========================
    // Reports list UI (Nuova vista espandibile)
    // =========================
    const listEl = document.getElementById("list");
    const emptyState = document.getElementById("emptyState");

    window.goToHistory = function(id) {
      location.hash = "#/my";
      setTimeout(() => {
        const el = document.getElementById("storico-" + id);
        if(el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.classList.add("highlight"); }
      }, 350);
    };

    function renderList(){
      const arr = loadReports();
      listEl.innerHTML = "";
      emptyState.style.display = arr.length ? "none" : "block";

      arr.slice().reverse().forEach((r) => {
        const item = document.createElement("div");
        item.className = "item cat-" + (r.categoria || "altro");
        item.id = "storico-" + r.id;

        const top = document.createElement("div"); top.className = "item-top";
        
        const body = document.createElement("div"); body.style.flex = "1";
        const h3 = document.createElement("h3"); h3.textContent = r.titolo || "(senza titolo)";
        const p = document.createElement("p"); p.textContent = r.descrizione || "";
        
        const meta = document.createElement("div"); meta.className = "metaRow";
        const p1 = document.createElement("span"); p1.className = "pill"; p1.textContent = "ğŸ•’ " + r.when;
        const p2 = document.createElement("span"); p2.className = "pill"; p2.textContent = r.anonimo ? "ğŸ•¶ï¸ Anonimo" : "ğŸ“Œ Contatto";
        meta.append(p1, p2);

        // Bottone Foto Espandibile
        const arrPhotos = r.photos || [];
        if(!arrPhotos.length && r.photoDataUrl) arrPhotos.push({dataUrl: r.photoDataUrl});
        
        let galDiv = null;
        if(arrPhotos.length > 0) {
          const btnFoto = document.createElement("button"); btnFoto.className = "btn ghost small"; btnFoto.textContent = `ğŸ“· Vedi Foto (${arrPhotos.length})`;
          meta.append(btnFoto);
          galDiv = document.createElement("div"); galDiv.className = "gallery-grid hidden";
          arrPhotos.forEach(ph => {
            const im = document.createElement("img"); im.src = ph.dataUrl; im.className = "gallery-img";
            im.onclick = (e) => { e.stopPropagation(); window.open(ph.dataUrl); };
            galDiv.appendChild(im);
          });
          btnFoto.onclick = (e) => { e.stopPropagation(); galDiv.classList.toggle("hidden"); };
        }

        // Bottone Mappa
        if(r.geo && typeof r.geo.lat === "number"){
          const btnMappa = document.createElement("button"); btnMappa.className = "btn ghost small"; btnMappa.textContent = "ğŸ—ºï¸ Vedi in mappa";
          btnMappa.onclick = (e) => { e.stopPropagation(); location.hash="#/map"; setTimeout(()=>mapMain?.setView([r.geo.lat, r.geo.lng], 18), 300); };
          meta.append(btnMappa);
        }

        body.append(h3,p,meta);
        if(arrPhotos.length > 0 && galDiv) body.append(galDiv);
        top.append(body); item.append(top);
        listEl.append(item);
      });
    }

    document.getElementById("btnClearAll").addEventListener("click", () => {
      if(!confirm("Vuoi svuotare tutto l'archivio sul tuo dispositivo?")) return;
      saveReports([]); renderList(); refreshAllMaps(); showBanner("info", "Archivio svuotato.", 2500);
    });

    // =========================
    // Mappe (Leaflet)
    // =========================
    let mapHome = null, mapContacts = null, mapMain = null;
    let layerHome = null, layerContacts = null, layerMain = null;

    function createBaseMap(elId, opts = {}){
      const el = document.getElementById(elId); if(!el) return null;
      const m = L.map(el, { zoomControl: true }).setView(opts.center || [41.492, 13.831], opts.zoom || 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: 'Â© OpenStreetMap' }).addTo(m);
      return m;
    }

    function ensureMaps(){
      if(!mapHome && document.getElementById("mapHome")){ mapHome = createBaseMap("mapHome", { zoom: 12 }); layerHome = L.layerGroup().addTo(mapHome); }
      if(!mapContacts && document.getElementById("mapContacts")){ mapContacts = createBaseMap("mapContacts", { zoom: 12 }); layerContacts = L.layerGroup().addTo(mapContacts); }
      if(!mapMain && document.getElementById("mapMain")){ mapMain = createBaseMap("mapMain", { zoom: 12 }); layerMain = L.layerGroup().addTo(mapMain); }
    }

    const colorMap = { verde: '#19c37d', strade: '#95a5a6', rifiuti: '#f39c12', luce: '#f1c40f', altro: '#2d7dff' };

    function fillLayer(layer, mapObj, limit = Infinity){
      if(!layer || !mapObj) return; layer.clearLayers();
      const items = loadReports().filter(r => r.geo).slice().reverse().slice(0, limit);

      items.forEach(r => {
        const color = colorMap[r.categoria] || '#2d7dff';
        const mk = L.circleMarker([r.geo.lat, r.geo.lng], { radius: 10, color: color, fillColor: color, fillOpacity: 0.85, riseOnHover: true });
        mk.addTo(layer);
        mk.bindPopup(`
          <div style="min-width:200px">
            <div style="font-weight:950;margin-bottom:6px">${r.titolo}</div>
            <div style="opacity:.85;font-size:12px;margin-bottom:8px">${r.when}</div>
            <button onclick="goToHistory('${r.id}')" style="width:100%; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.08); color:#eaf0ff; border-radius: 14px; padding:10px; font-weight:900; cursor:pointer;">Apri segnalazione</button>
          </div>
        `, { closeButton:true });
      });

      if(items.length){ mapObj.fitBounds(L.latLngBounds(items.map(r => [r.geo.lat, r.geo.lng])).pad(0.25)); }
      else{ mapObj.setView([41.492, 13.831], 12); }
    }

    function refreshAllMaps(){
      try{ ensureMaps(); if(mapHome) fillLayer(layerHome, mapHome, 25); if(mapContacts) fillLayer(layerContacts, mapContacts, 25); if(mapMain) fillLayer(layerMain, mapMain, Infinity); }catch(e){}
    }
    document.getElementById("btnMapFit")?.addEventListener("click", () => {
      const items = loadReports().filter(r=>r.geo);
      if(!items.length) return showBanner("info", "Nessun punto sulla mappa.");
      mapMain?.fitBounds(L.latLngBounds(items.map(r => [r.geo.lat, r.geo.lng])).pad(0.25));
    });

    // =========================
    // INIT APP
    // =========================
    initStorage().then(() => {
      route();
      renderPhotoPreview();
      renderList();
      renderGeo();
      ensureMaps();
      refreshAllMaps();
    });
  </script>
</body>
</html>
