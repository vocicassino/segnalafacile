<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Segnala Facile PWA</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:white}
section{padding:20px;display:none}
section.active{display:block}
input,textarea{width:100%;padding:8px;border-radius:8px;border:none;margin-bottom:10px}
button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;margin:5px 3px}
.report{background:#1e293b;padding:15px;border-radius:12px;margin-bottom:15px}
#map{height:60vh;border-radius:12px;margin-top:10px}
.photoModal{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:9999}
.photoModal.hidden{display:none}
.galleryContainer{display:flex;overflow-x:auto;gap:15px;padding:20px}
.galleryImg{max-height:80vh;border-radius:12px}
nav{position:fixed;bottom:0;width:100%;display:flex;justify-content:space-around;background:#1e293b;padding:10px}
nav button{background:none;color:white;font-weight:bold}
</style>
</head>
<body>

<section id="home" class="active">
<h2>Nuova Segnalazione</h2>
<input type="text" id="titolo" placeholder="Titolo">
<textarea id="descrizione" placeholder="Descrizione"></textarea>
<input type="file" id="fotoInput" multiple accept="image/*">
<button onclick="getLocation()">üìç Usa posizione attuale</button>
<button onclick="saveReport()">Salva Segnalazione</button>
</section>

<section id="my">
<h2>Storico Segnalazioni</h2>
<div id="reportList"></div>
</section>

<section id="mapSection">
<h2>Mappa Segnalazioni</h2>
<div id="map"></div>
</section>

<div id="photoModal" class="photoModal hidden">
<div>
<button onclick="closeGallery()">Chiudi ‚úñ</button>
<div id="photoContainer" class="galleryContainer"></div>
</div>
</div>

<nav>
<button onclick="show('home')">Home</button>
<button onclick="show('my');loadReports()">Storico</button>
<button onclick="show('mapSection');setTimeout(loadAllMarkers,200)">Mappa</button>
</nav>

<script>
let selectedPhotos=[];
let currentLat=null;
let currentLng=null;
let map;
let markersLayer;

function show(id){
document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
}

document.getElementById("fotoInput").addEventListener("change",function(e){
selectedPhotos=[];
Array.from(e.target.files).forEach(file=>{
const reader=new FileReader();
reader.onload=function(ev){
selectedPhotos.push({dataUrl:ev.target.result,name:file.name});
};
reader.readAsDataURL(file);
});
});

function getLocation(){
navigator.geolocation.getCurrentPosition(pos=>{
currentLat=pos.coords.latitude;
currentLng=pos.coords.longitude;
alert("Posizione acquisita");
});
}

function saveReport(){
const titolo=document.getElementById("titolo").value;
const descrizione=document.getElementById("descrizione").value;
if(!titolo || !descrizione){alert("Compila tutti i campi");return;}
const report={
id:Date.now(),
titolo,
descrizione,
when:new Date().toLocaleString(),
photos:selectedPhotos,
lat:currentLat,
lng:currentLng
};
let reports=JSON.parse(localStorage.getItem("sf_reports")||"[]");
reports.unshift(report);
localStorage.setItem("sf_reports",JSON.stringify(reports));
selectedPhotos=[];
document.getElementById("fotoInput").value="";
alert("Segnalazione salvata!");
loadReports();
}

function loadReports(){
const list=document.getElementById("reportList");
list.innerHTML="";
const reports=JSON.parse(localStorage.getItem("sf_reports")||"[]");
reports.forEach(r=>{
const div=document.createElement("div");
div.className="report";
div.innerHTML=`<b>${r.titolo}</b><br>${r.descrizione}<br><small>${r.when}</small><br><br>
<button onclick='openPhotoGallery(${JSON.stringify(r.photos)})'>üì∑ Foto</button>
<button onclick='goToMap(${r.lat},${r.lng})'>üìç In mappa</button>`;
list.appendChild(div);
});
}

function openPhotoGallery(photos){
if(!photos||!photos.length)return;
const modal=document.getElementById("photoModal");
const container=document.getElementById("photoContainer");
container.innerHTML="";
photos.forEach(p=>{
const img=document.createElement("img");
img.src=p.dataUrl;
img.className="galleryImg";
container.appendChild(img);
});
modal.classList.remove("hidden");
}

function closeGallery(){
document.getElementById("photoModal").classList.add("hidden");
}

function initMap(){
map=L.map('map').setView([41.492,13.829],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
markersLayer=L.layerGroup().addTo(map);
}

function loadAllMarkers(){
if(!map)return;
markersLayer.clearLayers();
const reports=JSON.parse(localStorage.getItem("sf_reports")||"[]");
reports.forEach(r=>{
if(r.lat&&r.lng){
L.marker([r.lat,r.lng]).addTo(markersLayer).bindPopup(`<b>${r.titolo}</b><br>${r.descrizione}`);
}
});
}

function goToMap(lat,lng){
show("mapSection");
setTimeout(()=>{
if(lat&&lng){
map.setView([lat,lng],16);
}
},300);
}

initMap();
loadReports();
</script>

</body>
</html>
