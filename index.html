<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>SegnalaFacile Pro</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#0b1220; --bg2:#070c18; --text:#eaf0ff; --muted:#a9b6db;
      --accent:#2d7dff; --accent2:#19c37d; --danger:#ff4d4f;
      --stroke:rgba(255,255,255,.10); --stroke2:rgba(255,255,255,.16);
      --r:22px; --r2:28px;
      --shadow: 0 18px 45px rgba(0,0,0,.40); --shadow2: 0 10px 25px rgba(0,0,0,.35);
      --glass1: rgba(255,255,255,.08); --glass2: rgba(255,255,255,.04);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(45,125,255,.28), transparent 55%),
        radial-gradient(1100px 700px at 85% 5%, rgba(25,195,125,.20), transparent 60%),
        radial-gradient(900px 650px at 50% 120%, rgba(45,125,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      background-attachment: fixed;
    }

    .wrap{
      max-width: 920px; margin: 0 auto;
      padding: 18px 16px calc(132px + env(safe-area-inset-bottom));
    }

    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 10px 0 12px; }
    .brand{display:flex; align-items:center; gap:14px;}
    .logo{
      width:70px; height:70px; border-radius:22px;
      background: url("icons/icon-192.png") center/cover no-repeat, linear-gradient(135deg, rgba(45,125,255,.95), rgba(25,195,125,.90));
      box-shadow: 0 18px 40px rgba(0,0,0,.45); outline: 1px solid rgba(255,255,255,.10); flex:0 0 auto;
    }
    .title{ font-size: 28px; font-weight: 980; letter-spacing: -.35px; line-height: 1.05; }

    .grid{display:grid; gap:14px; position:relative;}

    .card{
      position:relative;
      background: linear-gradient(145deg, rgba(38,86,108,.85), rgba(12,25,45,.85));
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 28px; padding: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      margin-bottom: 28px; min-height: 60vh;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .card::before{
      content:""; position:absolute; inset:-1px;
      background: radial-gradient(740px 160px at 20% 0%, rgba(45,125,255,.22), transparent 55%),
                  radial-gradient(740px 160px at 85% 0%, rgba(25,195,125,.18), transparent 55%);
      pointer-events:none; opacity:.95; border-radius: 28px;
    }
    .card > *{position:relative}

    .heroTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .heroCover{
      width: 100%; height: 180px; object-fit: cover; border-radius: 24px;
      border: 1px solid rgba(255,255,255,.12); box-shadow: 0 18px 45px rgba(0,0,0,.38);
      display: block; margin: 14px 0 16px; filter: saturate(1.05) contrast(1.02);
    }
    @media (min-width: 520px){ .heroCover{ height: 210px; } }
    .hero h1{ margin:0 0 10px; font-size: 34px; line-height: 1.08; letter-spacing: -.7px; }
    .hero p{ margin:0; color: var(--muted); font-size: 15px; line-height: 1.55; max-width: 62ch; }

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    button, .btn{
      cursor:pointer; border:0; border-radius: 18px; padding: 12px 14px; font-weight: 900; font-size: 14px;
      display:inline-flex; align-items:center; justify-content:center; gap:10px; text-decoration:none;
      color: var(--text); -webkit-tap-highlight-color: transparent; touch-action: manipulation;
      transition: transform .12s ease, filter .12s ease, background .12s ease, border-color .12s ease;
      user-select:none; min-height: 46px;
    }
    button:active, .btn:active{transform: translateY(1px) scale(.99)}
    button:disabled{opacity:.65; cursor:not-allowed; transform:none !important}

    .primary{ background: linear-gradient(135deg, rgba(45,125,255,1), rgba(45,125,255,.70)); box-shadow: 0 18px 36px rgba(45,125,255,.18); }
    .primary:hover{filter: brightness(1.06)}
    .ghost{ background: rgba(255,255,255,.055); border:1px solid var(--stroke); }
    .ghost:hover{border-color: var(--stroke2)}
    .danger{ background: rgba(255,77,79,.14); border:1px solid rgba(255,77,79,.35); color: var(--danger); }
    .danger:hover{border-color: rgba(255,77,79,.55)}
    .small{padding:10px 12px; border-radius:16px; font-size:13px; min-height:42px}

    .ctaBig{
      width:100%; padding: 16px 16px; border-radius: 22px; font-size: 16px; font-weight: 980; min-height: 56px;
      background: linear-gradient(135deg, rgba(45,125,255,1), rgba(45,125,255,.62));
      box-shadow: 0 22px 44px rgba(45,125,255,.20); position:relative; overflow:hidden;
    }
    .ctaBig::after{
      content:""; position:absolute; inset:-40%;
      background: radial-gradient(circle at 20% 40%, rgba(255,255,255,.22), transparent 42%),
                  radial-gradient(circle at 80% 60%, rgba(25,195,125,.16), transparent 46%);
      transform: rotate(12deg); opacity:.8; pointer-events:none;
    }
    .ctaBig .dot{
      width: 10px; height: 10px; border-radius: 999px; background: rgba(255,255,255,.9);
      box-shadow: 0 0 0 6px rgba(255,255,255,.12); z-index:1;
    }
    .ctaBig span, .ctaBig .dot{position:relative}
    .ctaBig:hover{filter: brightness(1.06)}

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row > *{flex:1 1 220px}

    label{ display:block; font-size: 12px; color: var(--muted); margin: 12px 0 7px; font-weight: 850; letter-spacing: .25px; }

    input[type="text"], input[type="email"], input[type="tel"], textarea, select{
      width:100%; padding: 12px 12px; border-radius: 18px; border: 1px solid var(--stroke);
      background: rgba(0,0,0,.22); color: var(--text); outline:none; transition: border-color .12s ease, box-shadow .12s ease;
    }
    input:focus, textarea:focus, select:focus{ border-color: rgba(45,125,255,.55); box-shadow: 0 0 0 3px rgba(45,125,255,.16); }
    textarea{min-height:120px; resize:vertical}
    select option { background: var(--bg2); color: var(--text); }

    .hint{ font-size:12.5px; color: var(--muted); margin-top:10px; line-height:1.5; }

    .toggle{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 12px; border-radius: 20px; border:1px solid var(--stroke);
      background: rgba(0,0,0,.18); margin-top: 12px;
    }
    .toggle span{color:var(--muted); font-size:13px}
    .toggle strong{font-size:13px; font-weight:980}
    .toggle input{transform: scale(1.15)}

    .contactBox{ margin-top: 12px; padding: 12px; border-radius: 22px; border: 1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.16); }
    .contactTitle{ font-weight: 980; letter-spacing: .2px; margin: 0 0 6px; display:flex; align-items:center; gap:10px; }
    .contactGrid{ display:grid; gap:10px; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (max-width: 640px){ .contactGrid{grid-template-columns: 1fr;} }

    .preview{
      margin-top: 12px; display:none; gap: 12px; align-items:flex-start; padding: 12px;
      border-radius: 22px; border:1px dashed rgba(255,255,255,.18); background: rgba(0,0,0,.16);
    }
    .thumbs{ display:flex; flex-wrap:wrap; gap:8px; align-items:flex-start; padding:2px; }
    .thumbs img{
      width:76px; height:76px; object-fit:cover; border-radius:18px;
      border:1px solid var(--stroke); background:rgba(255,255,255,.05); box-shadow: 0 10px 18px rgba(0,0,0,.30);
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px; padding: 8px 12px; border-radius: 999px;
      background: rgba(255,255,255,.06); border: 1px solid var(--stroke); color: var(--text);
      font-size: 12px; font-weight: 900; box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }

    .list{display:grid; gap:10px; margin-top:12px}
    .item{
      padding: 14px; border-radius: 22px; background: rgba(0,0,0,.18); border: 1px solid var(--stroke);
      display:flex; flex-direction:column; gap:12px; transition: border-color .12s ease, transform .12s ease;
    }
    .item.highlight { border-color: var(--accent); box-shadow: 0 0 15px rgba(45,125,255,0.3); }
    .item-top { display:flex; gap:12px; align-items:flex-start; }
    .item:hover{border-color: var(--stroke2)}
    
    .cat-verde { border-left: 5px solid #19c37d; }
    .cat-strade { border-left: 5px solid #95a5a6; }
    .cat-rifiuti { border-left: 5px solid #f39c12; }
    .cat-luce { border-left: 5px solid #f1c40f; }
    .cat-altro, .cat-ristorante, .cat-negozio, .cat-cultura, .cat-natura { border-left: 5px solid #2d7dff; }

    .item h3{margin:0; font-size:16px; font-weight:950}
    .item p{margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.45}
    .metaRow{margin-top:8px; display:flex; flex-wrap:wrap; gap:8px}

    .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 10px; }
    .gallery-img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; border: 1px solid var(--stroke); cursor: pointer; }
    .place-img-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 12px; margin-top: 10px; border: 1px solid var(--stroke); }

    .hidden{display:none !important}
    section{display:none} section:not(.hidden){display:block}

    .ok{ display:flex; align-items:center; gap:12px; padding: 14px; border-radius: 22px; border: 1px solid rgba(25,195,125,.35); background: rgba(25,195,125,.12); }
    .banner{
      position: sticky; top: 10px; z-index: 2000; display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding: 12px 12px; border-radius: 22px; border:1px solid var(--stroke); background: rgba(255,255,255,.06);
      backdrop-filter: blur(12px); box-shadow: var(--shadow2); margin: 0 0 12px;
    }
    .banner .text{font-size:13px; line-height:1.35; color:var(--text)}
    .banner .close{ flex:0 0 auto; border:1px solid var(--stroke); background: rgba(0,0,0,.20); color: var(--text); border-radius: 16px; padding: 8px 10px; font-weight: 950; }
    .banner.info{border-color: rgba(45,125,255,.35); background: rgba(45,125,255,.10)}
    .banner.success{border-color: rgba(25,195,125,.35); background: rgba(25,195,125,.12)}
    .banner.error{border-color: rgba(255,77,79,.35); background: rgba(255,77,79,.12)}

    .progressWrap{ margin-top: 12px; padding: 12px; border-radius: 22px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.16); display:none; }
    .progressTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 10px; }
    .progressTitle{ font-weight: 980; letter-spacing: .2px; display:flex; align-items:center; gap:10px; }
    .stepPill{ font-size: 12px; font-weight: 950; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color: var(--text); white-space: nowrap; }
    .bar{ height: 10px; border-radius: 999px; background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); overflow:hidden; }
    .bar > span{ display:block; height:100%; width: 0%; background: linear-gradient(90deg, rgba(45,125,255,1), rgba(25,195,125,1)); transition: width .25s ease; }
    .progressHint{ margin-top: 10px; font-size: 12.5px; color: var(--muted); line-height: 1.45; }

    .emptyState{ text-align:center; opacity:.85; margin-top:40px; }
    .emptyIcon{ font-size:48px; margin-bottom:10px; }
    .contactInfo{ margin: 8px 2px 0; opacity:.75; font-size:14px; text-align:left; }

    /* CSS STELLINE RECENSIONE */
    .star-rating {
      display: flex; flex-direction: row-reverse; justify-content: flex-end;
      gap: 4px; font-size: 32px; margin-bottom: 12px; margin-top: 4px;
    }
    .star-rating input { display: none; }
    .star-rating label { cursor: pointer; color: rgba(255,255,255,0.15); transition: 0.2s; }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label { color: #ff9f43; }

    /* MAP UI */
    .mapShell{
      margin-top: 14px; border-radius: 24px; border: 1px solid rgba(255,255,255,.12); overflow:hidden;
      background: rgba(0,0,0,.16); box-shadow: 0 18px 45px rgba(0,0,0,.32);
    }
    .mapTopBar{
      display:flex; justify-content:space-between; align-items:center; gap:10px; padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04);
    }
    .mapTitle{ font-weight: 980; letter-spacing: .2px; }
    .mapHint{ font-size:12.5px; color: var(--muted); margin: 6px 0 0; line-height: 1.35; }
    .mapBox{ width:100%; height: 320px; }
    .mapBox.big{ height: 520px; }
    @media (max-width: 420px){ .mapBox.big{ height: 460px; } }

    /* Modals */
    .modalOverlay{
      position: fixed; inset: 0; background: rgba(0,0,0,.55); backdrop-filter: blur(8px);
      display:none; align-items:center; justify-content:center; z-index: 99999; padding: 14px;
    }
    .modal{
      width: min(920px, 100%); background: linear-gradient(145deg, rgba(38,86,108,.92), rgba(12,25,45,.92));
      border: 1px solid rgba(255,255,255,.14); border-radius: 28px; box-shadow: 0 28px 80px rgba(0,0,0,.55);
      padding: 16px; position:relative; overflow:hidden;
    }
    .modalHeader{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; margin-bottom: 10px; }
    .modalHeader h3{ margin:0; font-size:16px; font-weight: 980; letter-spacing: -.2px; }
    .modalClose{
      border:1px solid rgba(255,255,255,.16); background: rgba(0,0,0,.20); color: var(--text);
      border-radius: 16px; padding: 8px 10px; font-weight: 950; min-height: 40px; cursor:pointer;
    }
    .mapPickerBox{ width:100%; height: 380px; border-radius: 22px; overflow:hidden; border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.16); margin-top: 10px; }

    /* Leaflet stile */
    .leaflet-container{ background: rgba(0,0,0,.18); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .leaflet-control-zoom a{ background: rgba(10,16,32,.75) !important; color: var(--text) !important; border: 1px solid rgba(255,255,255,.12) !important; backdrop-filter: blur(10px); }
    .leaflet-popup-content-wrapper{ background: rgba(10,16,32,.92); color: var(--text); border: 1px solid rgba(255,255,255,.12); box-shadow: 0 18px 50px rgba(0,0,0,.55); border-radius: 18px; backdrop-filter: blur(10px); }
    .leaflet-popup-tip{ background: rgba(10,16,32,.92); }

    /* DOCK PREMIUM */
    nav.bottom{ position: fixed; left: 0; right: 0; bottom: 0; z-index: 9999; padding: 10px 12px 12px; background: transparent; }
    nav .inner{
      max-width: 560px; margin: 0 auto; display:flex; justify-content:space-between; gap: 5px;
      padding: 10px; border-radius: 28px;
      background: radial-gradient(240px 120px at 20% 10%, rgba(45,125,255,.22), transparent 60%), radial-gradient(240px 120px at 80% 10%, rgba(25,195,125,.18), transparent 60%), rgba(9,14,28,.85);
      border: 1px solid rgba(255,255,255,.12); box-shadow: 0 18px 50px rgba(0,0,0,.55); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); position:relative; overflow:hidden;
    }
    nav .inner::before{
      content:""; position:absolute; inset:-1px; border-radius: 28px; pointer-events:none;
      background: linear-gradient(135deg, rgba(45,125,255,.30), rgba(25,195,125,.22), rgba(255,255,255,.06));
      opacity:.55; mask: linear-gradient(#000, #000) content-box, linear-gradient(#000, #000); -webkit-mask: linear-gradient(#000, #000) content-box, linear-gradient(#000, #000); padding:1px;
    }
    nav a{
      flex: 1; text-align:center; text-decoration:none; color: rgba(169,182,219,.92); font-size: 11px;
      padding: 10px 2px; border-radius: 22px; border: 1px solid transparent; transition: background .16s ease, border-color .16s ease, transform .16s ease, color .16s ease;
      display:flex; flex-direction:column; align-items:center; gap:6px; font-weight: 950; position:relative; overflow:hidden; min-height: 62px;
    }
    .navIco{ width: 26px; height: 26px; display:block; fill: currentColor; opacity: .98; transform: translateZ(0); }
    nav a:active{transform: translateY(1px)}
    nav a.active{ color: var(--text); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.14); }
    nav a.active::before{
      content:""; position:absolute; inset:-30%;
      background: radial-gradient(circle at 50% 35%, rgba(45,125,255,.40), transparent 45%), radial-gradient(circle at 50% 80%, rgba(25,195,125,.22), transparent 55%);
      opacity:.65; pointer-events:none; transform: translateY(-6px);
    }
    nav a.active::after{
      content:""; position:absolute; bottom:8px; width: 6px; height: 6px; border-radius: 999px;
      background: rgba(255,255,255,.92); box-shadow: 0 0 0 6px rgba(45,125,255,.14); opacity:.95;
    }

    @media (prefers-reduced-motion: no-preference){
      nav a.active .navIco{ animation: navPulse 1.9s ease-in-out infinite; }
      @keyframes navPulse{
        0%   { transform: translateY(0) scale(1); filter: drop-shadow(0 0 0 rgba(45,125,255,0)); }
        45%  { transform: translateY(-1px) scale(1.05); filter: drop-shadow(0 10px 18px rgba(45,125,255,.18)); }
        100% { transform: translateY(0) scale(1); filter: drop-shadow(0 0 0 rgba(45,125,255,0)); }
      }
      .card{animation: pop .18s ease both}
      @keyframes pop{ from{transform: translateY(8px); opacity:0} to{transform: translateY(0); opacity:1} }
    }

    /* Docs preview */
    .docsList{ display:grid; gap:8px; margin-top:10px; }
    .docItem{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 10px 12px; border-radius: 18px; border:1px solid var(--stroke); background: rgba(0,0,0,.14); }
    .docItem .left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .docBadge{ width: 42px; height: 42px; border-radius: 16px; display:grid; place-items:center; font-weight: 980; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); flex:0 0 auto; }
    .docMeta{min-width:0}
    .docName{ font-weight: 950; font-size: 13px; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; max-width: 54vw; }
    .docSize{ font-size: 12px; color: var(--muted); margin-top:2px; }

    .metaCol{ display:flex; flex-direction:column; gap:8px; min-width:170px; }
    @media (max-width: 520px){
      .metaCol{ min-width:0; width:100%; }
      .preview{ flex-direction:column; align-items:stretch; }
      .thumbs{ justify-content:flex-start; overflow-x:auto; flex-wrap:nowrap; -webkit-overflow-scrolling:touch; padding-bottom:6px; }
      .thumb{ flex:0 0 auto; }
      .row{ flex-wrap:wrap; }
      .row > .btn{ flex:1 1 100%; }
    }

    /* FILTRI MAPPA */
    .filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    .filter-btn { 
      background: rgba(255,255,255,0.06); color: var(--text); border: 1px solid var(--stroke); 
      padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 800; cursor: pointer; transition: 0.2s ease; 
    }
    .filter-btn:hover { background: rgba(255,255,255,0.12); }
    .filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); box-shadow: 0 4px 10px rgba(45,125,255,0.3); }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div><div class="title">Segnala Facile</div></div>
      </div>
      <button class="pill" id="installPill" style="display:inline-flex; cursor:pointer; background: #19c37d; color: white; border: none;" type="button">‚¨áÔ∏è Installa App</button>
    </header>

    <div id="banner" class="banner hidden" role="status" aria-live="polite">
      <div class="text" id="bannerText"></div>
      <button class="close" id="bannerClose" type="button">‚úï</button>
    </div>

    <section id="view-home" class="grid">
      <div class="card hero">
        <div class="heroTop">
          <div>
            <h1>La tua Citt√†.</h1>
            <p>Segnala problemi, scopri luoghi e leggi le recensioni della community.</p>
          </div>
          <img class="heroCover" src="icons/hero.jpg" alt="SegnalaFacile" loading="lazy">
        </div>

        <div class="btnRow">
          <a class="btn ctaBig" href="#/report"><span class="dot"></span> Invia segnalazione</a>
        </div>

        <div class="btnRow">
          <a class="btn ghost" href="#/places">‚≠ê Scopri Luoghi</a>
          <a class="btn ghost" href="#/my">üóÇÔ∏è Le mie segnalazioni</a>
          <a class="btn ghost" href="#/contacts">‚òéÔ∏è Contatti Comune</a>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
          <div>
            <div style="font-weight:980;margin-bottom:4px">Mappa in tempo reale</div>
            <div class="hint" style="margin:0">Punti = Segnalazioni | Stelle = Luoghi</div>
          </div>
          <a class="btn small ghost" href="#/map">Mappa ‚Üí</a>
        </div>

        <div class="mapShell" style="margin-top:14px">
          <div id="mapHome" class="mapBox"></div>
        </div>
      </div>
    </section>

    <section id="view-report" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:980;font-size:18px">Nuova segnalazione</div>
            <div class="hint" style="margin:6px 0 0">Compila i campi e premi ‚ÄúInvia‚Äù.</div>
          </div>
          <a class="btn small ghost" href="#/">‚Üê Home</a>
        </div>

        <label for="titolo">Titolo</label>
        <input id="titolo" type="text" maxlength="80" placeholder="Es. Lampione spento in via‚Ä¶" />

        <label for="categoria">Categoria</label>
        <select id="categoria">
          <option value="verde">üå≥ Verde Pubblico</option>
          <option value="strade">üõ£Ô∏è Strade e Marciapiedi</option>
          <option value="rifiuti">üóëÔ∏è Rifiuti/Decoro</option>
          <option value="luce">üí° Illuminazione</option>
          <option value="altro">‚ùì Altro</option>
        </select>

        <label for="descrizione">Descrizione</label>
        <textarea id="descrizione" maxlength="700" placeholder="Spiega cosa succede, dove e quando‚Ä¶"></textarea>

        <label>Posizione (opzionale)</label>
        <div class="row">
          <button class="ghost" id="btnGeoOnce" type="button">üìç Usa posizione attuale</button>
          <button class="ghost" id="btnGeoLive" type="button">üõ∞Ô∏è Posizione in tempo reale: OFF</button>
          <button class="ghost" id="btnGeoPick" type="button">üó∫Ô∏è Inserisci a mano sulla mappa</button>
          <button class="ghost" id="btnGeoClear" type="button">üßπ Rimuovi posizione</button>
        </div>
        <div id="geoLine" class="hint" style="margin-top:10px; display:none;"></div>

        <label>Foto (opzionale)</label>
        <div class="row">
          <button class="ghost" id="btnPickCamera" type="button">üì∑ Scatta foto</button>
          <button class="ghost" id="btnPickGallery" type="button">üñºÔ∏è Scegli dalla galleria</button>
          <input id="fotoCamera" type="file" accept="image/*" capture="environment" class="hidden" />
          <input id="fotoGallery" type="file" accept="image/*" multiple class="hidden" />
          <button class="danger" id="btnClearPhoto" type="button">üßπ Rimuovi</button>
        </div>

        <div id="photoPreview" class="preview">
          <div class="metaCol">
            <div style="font-weight:980;color:var(--text)">Anteprima foto</div>
            <div id="photoMeta" class="hint" style="margin:0"></div>
          </div>
          <div class="thumbs" id="thumbs"></div>
        </div>
        
        <label>Documenti (PDF/Word - opzionale)</label>
        <div class="row">
          <button class="ghost" id="btnPickDocs" type="button">üìé Aggiungi documenti</button>
          <input id="docsInput" type="file" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" multiple class="hidden" />
          <button class="danger" id="btnClearDocs" type="button">üßπ Rimuovi documenti</button>
        </div>

        <div id="docsPreview" class="preview">
          <div class="metaCol">
            <div style="font-weight:980;color:var(--text)">Allegati</div>
            <div id="docsMeta" class="hint" style="margin:0"></div>
          </div>
          <div class="docsList" id="docsList"></div>
        </div>

        <div class="toggle">
          <div>
            <strong>Invia anche in forma anonima</strong><br>
            <span>Se disattivi, puoi lasciare un contatto per essere richiamato</span>
          </div>
          <input id="anonimo" type="checkbox" checked />
        </div>

        <div id="contactBox" class="contactBox hidden">
          <div class="contactTitle">üìå Dati per essere contattato</div>
          <div class="hint" style="margin:0 0 10px">Inserisci almeno <b>Email</b> o <b>Telefono</b>.</div>
          <div class="contactGrid">
            <div>
              <label for="contactName">Nome e Cognome (opzionale)</label>
              <input id="contactName" type="text" maxlength="80" placeholder="Es. Mario Rossi" />
            </div>
            <div>
              <label for="contactPhone">Telefono (opzionale)</label>
              <input id="contactPhone" type="tel" maxlength="30" placeholder="Es. 333 123 4567" />
            </div>
            <div style="grid-column: 1 / -1;">
              <label for="contactEmail">Email (opzionale)</label>
              <input id="contactEmail" type="email" maxlength="120" placeholder="Es. nome@email.it" />
            </div>
          </div>
        </div>

        <div id="progressWrap" class="progressWrap">
          <div class="progressTop">
            <div class="progressTitle">üöÄ Invio in corso‚Ä¶</div>
            <div class="stepPill" id="progressStep">1/3</div>
          </div>
          <div class="bar"><span id="progressBar"></span></div>
          <div class="progressHint" id="progressHint">Preparazione‚Ä¶</div>
        </div>

        <div class="btnRow">
          <button class="primary" id="btnSend" type="button">‚úÖ Invia Segnalazione</button>
          <a class="btn ghost" href="#/my">üóÇÔ∏è Vedi storico</a>
        </div>
        <div class="hint">La segnalazione viene inviata al server e salvata sul dispositivo.</div>
      </div>
    </section>

    <section id="view-success" class="grid hidden">
      <div class="card">
        <div class="ok">
          <div style="font-size:22px">‚úÖ</div>
          <div>
            <div style="font-weight:980;font-size:18px">Segnalazione inviata correttamente</div>
            <div class="hint" style="margin:6px 0 0">Grazie per il tuo contributo.</div>
          </div>
        </div>
        <div class="btnRow" style="margin-top:14px">
          <a class="btn primary" href="#/">üè† Torna alla Home</a>
          <a class="btn ghost" href="#/my">üóÇÔ∏è Le mie segnalazioni</a>
        </div>
      </div>
    </section>

    <section id="view-places" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
          <div>
            <div style="font-weight:980;font-size:18px">Luoghi e Recensioni</div>
            <div class="hint" style="margin:0">Scopri i posti suggeriti.</div>
          </div>
          <button class="btn primary small" onclick="location.hash='#/add-place'">‚ûï Recensisci</button>
        </div>
        <div id="public-places-list" class="list">
           <div class="hint" style="text-align:center;">Caricamento dati dal cloud...</div>
        </div>
      </div>
    </section>

    <section id="view-add-place" class="grid hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 style="margin:0">Nuova Recensione</h2>
          <a class="btn small ghost" href="#/places">‚Üê Indietro</a>
        </div>
        
        <label>Nome del Locale o Posto</label>
        <input id="placeName" type="text" placeholder="Es. Pizzeria Da Mario, Parco Naturale...">

        <label>Categoria</label>
        <select id="placeCategory">
          <option value="ristorante">üçï Ristorante / Bar</option>
          <option value="negozio">üõçÔ∏è Negozio</option>
          <option value="cultura">üèõÔ∏è Monumento / Cultura</option>
          <option value="natura">üå≤ Natura / Parco</option>
        </select>

        <label>Valutazione</label>
        <div class="star-rating" id="starRating">
          <input type="radio" id="star5" name="rating" value="5" checked><label for="star5">‚òÖ</label>
          <input type="radio" id="star4" name="rating" value="4"><label for="star4">‚òÖ</label>
          <input type="radio" id="star3" name="rating" value="3"><label for="star3">‚òÖ</label>
          <input type="radio" id="star2" name="rating" value="2"><label for="star2">‚òÖ</label>
          <input type="radio" id="star1" name="rating" value="1"><label for="star1">‚òÖ</label>
        </div>

        <label>La tua recensione</label>
        <textarea id="placeReview" placeholder="Come ti sei trovato? Cosa consigli?"></textarea>

        <label>Posizione e Foto</label>
        <div class="row">
          <button class="ghost" id="btnPlaceGeoPick" type="button">üìç Posizione sulla mappa (Obbligatoria)</button>
          <button class="ghost" onclick="document.getElementById('placePhotoInput').click()" type="button">üì∑ Aggiungi Foto</button>
          <input type="file" id="placePhotoInput" accept="image/*" class="hidden" />
        </div>
        <div id="placeGeoLine" class="hint" style="margin-top:10px; color:var(--accent2); font-weight:bold;"></div>
        <div id="placePhotoPreview" style="margin-top:10px;"></div>

        <button class="btn primary" id="btnSendPlace" type="button" style="width:100%; margin-top:20px;">‚≠ê Pubblica Recensione</button>
      </div>
    </section>

    <section id="view-my" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:980;font-size:18px">Le mie segnalazioni</div>
            <div class="hint" style="margin:6px 0 0">Il tuo archivio locale.</div>
          </div>
          <div class="row" style="flex:0 0 auto">
            <a class="btn small ghost" href="#/report">‚ûï Nuova</a>
            <button class="btn small danger" id="btnClearAll" type="button">üóëÔ∏è Svuota Tutto</button>
          </div>
        </div>

        <div id="emptyState" class="hint" style="margin-top:12px">
          <div class="emptyState">
            <div class="emptyIcon">üìÇ</div>
            <h3 style="margin:0 0 6px">Nessuna segnalazione</h3>
            <p style="margin:0;color:var(--muted)">Quando invii una segnalazione, la troverai qui.</p>
          </div>
        </div>

        <div id="list" class="list"></div>
      </div>
    </section>

    <section id="view-map" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:980;font-size:18px">Mappa segnalazioni e luoghi</div>
            <div class="hint" style="margin:6px 0 0">Dati condivisi dalla community.</div>
          </div>
          <button class="btn small ghost" onclick="fetchPublicData()" type="button">üîÑ Sincronizza</button>
        </div>
        <div class="mapShell" style="margin-top:14px">
          <div class="mapTopBar">
            <div>
              <div class="mapTitle">Tutti i punti</div>
            </div>
            <button class="btn small ghost" id="btnMapFit" type="button">üéØ Inquadra Tutto</button>
          </div>
          <div id="mapMain" class="mapBox big"></div>
        </div>
      </div>
    </section>

    <section id="view-contacts" class="grid hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:980;font-size:18px">Contatti</div>
            <div class="hint" style="margin:6px 0 0">Per comunicazioni generali al Comune.</div>
          </div>
          <a class="btn small ghost" href="#/">‚Üê Home</a>
        </div>
        <div class="btnRow" style="margin-top:14px">
          <a class="btn ghost" id="mailLink" href="#">‚úâÔ∏è Email</a>
          <a class="btn ghost" id="mapLink" href="#" target="_blank" rel="noreferrer">üìç Posizione Comune</a>
        </div>
      </div>
    </section>
  </div>

  <div class="modalOverlay" id="mapPickerOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mapPickerTitle">
      <div class="modalHeader">
        <h3 id="mapPickerTitle">Inserisci la posizione a mano</h3>
        <button class="modalClose" id="mapPickerClose" type="button">‚úï</button>
      </div>
      <div class="hint" style="margin:0">Tocca sulla mappa per piazzare il PIN. Poi premi ‚ÄúUsa questa posizione‚Äù.</div>
      <div id="mapPicker" class="mapPickerBox"></div>
      <div class="btnRow" style="margin-top:12px">
        <button class="btn primary" id="btnUsePicked" type="button">‚úÖ Usa questa posizione</button>
        <button class="btn ghost" id="btnCenterCassino" type="button">üéØ Centro Cassino</button>
      </div>
      <div class="hint" id="pickedLine" style="margin-top:10px">Nessun punto selezionato.</div>
    </div>
  </div>

  <nav class="bottom" aria-label="Navigazione">
    <div class="inner">
      <a href="#/" data-nav="home" class="active" aria-label="Home">
        <svg class="navIco" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l9 8h-2v10a1 1 0 0 1-1 1h-5v-6H11v6H6a1 1 0 0 1-1-1V11H3l9-8z"/></svg>
        <span>Home</span>
      </a>
      <a href="#/report" data-nav="report" aria-label="Segnala">
        <svg class="navIco" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 4h12a2 2 0 0 1 2 2v14H6a2 2 0 0 0-2 2V4zm4 4h8v2H8V8zm0 4h8v2H8v-2zm0 4h6v2H8v-2z"/>
          <path d="M20 8h2v14a2 2 0 0 1-2 2H8v-2h12V8z"/>
        </svg>
        <span>Segnala</span>
      </a>
      <a href="#/places" data-nav="places" aria-label="Luoghi">
        <svg class="navIco" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
        </svg>
        <span>Luoghi</span>
      </a>
      <a href="#/my" data-nav="my" aria-label="Storico">
        <svg class="navIco" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 4h10a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm2 4h6v2H9V8zm0 4h6v2H9v-2zm0 4h4v2H9v-2z"/></svg>
        <span>Storico</span>
      </a>
      <a href="#/map" data-nav="map" aria-label="Mappa">
        <svg class="navIco" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15 5l-6 2-6-2v15l6 2 6-2 6 2V7l-6-2zm0 2.1l4 1.3v11.4l-4-1.3V7.1zM9 7.1l4-1.3v11.4l-4 1.3V7.1zM3 8.4l4 1.3v11.4l-4-1.3V8.4z"/>
        </svg>
        <span>Mappa</span>
      </a>
    </div>
  </nav>

  <script>
    // =========================
    // CONFIG E VARIABILI GLOBALI
    // =========================

    // =========================
    // LOGICA INSTALLAZIONE INTELLIGENTE (APP PRINCIPALE)
    // =========================
    let deferredPrompt = null;
    
    // Intercetta l'evento di installazione se il browser lo permette (Android/Chrome)
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault(); 
      deferredPrompt = e;
    });

    document.getElementById("installPill").addEventListener("click", async () => {
      if (deferredPrompt) {
        // Se possibile, mostra il popup nativo e bellissimo di Android
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
      } else {
        // Se siamo su iPhone, o se l'app √® gi√† installata, mostra le istruzioni manuali
        alert(
          "Istruzioni per l'installazione:\n\n" +
          "üçè SU iPHONE (Safari): Tocca l'icona 'Condividi' in basso (il quadrato con la freccia che punta in alto) e scorri fino a 'Aggiungi alla schermata Home'.\n\n" +
          "ü§ñ SU ANDROID: Se non appare il popup, clicca sui 3 pallini in alto a destra del browser e seleziona 'Aggiungi a schermata Home'.\n\n" +
          "(Nota: se stai gi√† usando l'app dalla tua schermata Home, non c'√® bisogno di fare nulla!)"
        );
      }
    });
    
    const CONFIG = {
      email: "vocidicassino@proton.me",
      mapsQuery: "Cassino",
      // Assicurati che questo sia l'url del tuo Worker Cloudflare aggiornato
      telegramWorkerUrl: "https://segnalafacile-telegram.vocidicassino.workers.dev",
      telegramApiKey: "Marco-Admin-2026"
    };

    // Database Pubblico (Cloud D1)
    window.publicSegnalazioni = [];
    window.publicLuoghi = [];

    // Mappatura EMOJI per la Mappa
    const catInfo = { 
      verde:   { color: '#19c37d', emoji: 'üå≥' }, 
      strade:  { color: '#95a5a6', emoji: 'üõ£Ô∏è' }, 
      rifiuti: { color: '#f39c12', emoji: 'üóëÔ∏è' }, 
      luce:    { color: '#f1c40f', emoji: 'üí°' }, 
      altro:   { color: '#2d7dff', emoji: '‚ùì' } 
    };

    // =========================
    // INDEXEDDB - Gestione Memoria Locale
    // =========================
    let db;
    let localReportsCache = [];

    function initStorage() {
      return new Promise((resolve) => {
        const req = indexedDB.open("SegnalaFacile_v8", 1);
        req.onupgradeneeded = (e) => {
          e.target.result.createObjectStore("reports", { keyPath: "id" });
        };
        req.onsuccess = (e) => {
          db = e.target.result;
          const tx = db.transaction("reports", "readonly");
          const getReq = tx.objectStore("reports").getAll();
          getReq.onsuccess = () => { localReportsCache = getReq.result || []; resolve(); };
          getReq.onerror = () => { localReportsCache = []; resolve(); };
        };
        req.onerror = () => {
          try { localReportsCache = JSON.parse(localStorage.getItem("segnalafacile_reports_v7") || "[]"); } 
          catch { localReportsCache = []; }
          resolve();
        };
      });
    }

    function loadReports() { return localReportsCache; }
    function saveReports(arr) {
      localReportsCache = arr;
      if (db) {
        const tx = db.transaction("reports", "readwrite");
        const store = tx.objectStore("reports");
        store.clear();
        arr.forEach(i => store.put(i));
      } else {
        localStorage.setItem("segnalafacile_reports_v7", JSON.stringify(arr));
      }
    }

    // =========================
    // UI Helpers
    // =========================
    const banner = document.getElementById("banner");
    const bannerText = document.getElementById("bannerText");
    let bannerTimer = null;
    function showBanner(type, text, autoHideMs = 4000){
      if (bannerTimer) clearTimeout(bannerTimer);
      banner.classList.remove("hidden","info","success","error");
      banner.classList.add(type || "info");
      bannerText.textContent = text || "";
      if (autoHideMs) bannerTimer = setTimeout(() => banner.classList.add("hidden"), autoHideMs);
    }
    document.getElementById("bannerClose").addEventListener("click", () => banner.classList.add("hidden"));

    // =========================
    // ROUTER
    // =========================
    const views = ['home', 'report', 'success', 'my', 'map', 'contacts', 'places', 'add-place'];
    function route(){
      const hash = (location.hash || "#/").replace("#/", "");
      const target = views.includes(hash) ? hash : 'home';
      
      views.forEach(v => {
        const el = document.getElementById("view-" + v);
        if(el) { if(v === target) el.classList.remove("hidden"); else el.classList.add("hidden"); }
      });
      
      document.querySelectorAll("nav a[data-nav]").forEach(a => {
        a.classList.toggle("active", a.dataset.nav === target || (target==='add-place' && a.dataset.nav==='places'));
      });

      if(target === "my") renderList();
      if(target === "places") renderPublicPlaces();
      if(target === "map" || target === "home") { 
        ensureMaps(); refreshPublicMaps(); 
        setTimeout(() => { mapMain?.invalidateSize(); mapHome?.invalidateSize(); }, 60); 
      }
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
    window.addEventListener("hashchange", route);

    // =========================
    // CLOUD SYNC: RECUPERO DATI (D1)
    // =========================
    async function fetchPublicData() {
      try {
        const res = await fetch(CONFIG.telegramWorkerUrl + "/api/public-data");
        const data = await res.json();
        if(data.ok) {
          window.publicSegnalazioni = data.segnalazioni || [];
          window.publicLuoghi = data.luoghi || [];
          refreshPublicMaps();
          if(location.hash === '#/places') renderPublicPlaces();
        }
      } catch (e) { console.log("Offline mode - visualizzo solo dati locali."); }
    }

   function renderPublicPlaces() {
      const container = document.getElementById("public-places-list");
      if(!window.publicLuoghi.length) { 
        container.innerHTML = "<p class='hint' style='text-align:center;'>Nessun luogo recensito ancora.</p>"; 
        return; 
      }
      container.innerHTML = window.publicLuoghi.map((l, idx) => {
        const stars = '‚≠ê'.repeat(l.rating || 5);
        const uniqueId = 'place-' + idx; // ID unico per gestire l'apertura
        return `
          <div class="item cat-altro" style="cursor:pointer; transition:0.2s;" onclick="togglePlace('${uniqueId}')">
            
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
              <h3 style="margin:0">${stars} ${l.nome}</h3>
              <div style="display:flex; gap:8px; align-items:center;">
                <span class="pill">${l.categoria}</span>
                <span id="icon-${uniqueId}" style="font-size:14px; opacity:0.7; transition:0.3s;">‚ñº</span>
              </div>
            </div>
            
            <div id="desc-${uniqueId}" class="hidden" style="margin-top:12px; border-top:1px solid rgba(255,255,255,0.1); padding-top:12px; cursor:default;" onclick="event.stopPropagation()">
              <p style="margin:0 0 10px">${l.recensione}</p>
              ${l.foto ? `<img src="${l.foto}" class="place-img-preview" onclick="window.open('${l.foto}')">` : ''}
              
              <div class="row" style="margin-top:10px;">
                <button class="btn ghost small" onclick="focusOnMap(${l.lat}, ${l.lng})">üìç Vedi in mappa</button>
                <a class="btn primary small" href="https://www.google.com/maps/dir/?api=1&destination=${l.lat},${l.lng}" target="_blank" style="text-decoration:none;">üß≠ Raggiungi</a>
              </div>
            </div>

          </div>
        `;
      }).join('');
    }

    // Funzione che fa l'animazione di apertura/chiusura
    window.togglePlace = function(id) {
      const desc = document.getElementById('desc-' + id);
      const icon = document.getElementById('icon-' + id);
      if(desc.classList.contains('hidden')) {
        desc.classList.remove('hidden');
        icon.style.transform = "rotate(180deg)";
      } else {
        desc.classList.add('hidden');
        icon.style.transform = "rotate(0deg)";
      }
    };

    // =========================
    // MAPPE E MARKER
    // =========================
    let mapHome = null, mapMain = null;
    let layerHome = null, layerMain = null;

    function ensureMaps(){
      if(!mapHome && document.getElementById("mapHome")){ 
        mapHome = L.map("mapHome", { zoomControl: false, dragging: false }).setView([41.492, 13.831], 13); 
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapHome); 
        layerHome = L.layerGroup().addTo(mapHome); 
      }
      if(!mapMain && document.getElementById("mapMain")){ 
        mapMain = L.map("mapMain").setView([41.492, 13.831], 13); 
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(mapMain); 
        layerMain = L.layerGroup().addTo(mapMain); 
      }
    }

    function refreshPublicMaps() {
      if(layerMain) layerMain.clearLayers();
      if(layerHome) layerHome.clearLayers();
      const bounds = [];

      // 1. Aggiungi Segnalazioni (Emoji)
      const mixSegnalazioni = [...window.publicSegnalazioni];
      loadReports().filter(r => r.geo).forEach(lr => {
        if(!mixSegnalazioni.find(ps => ps.lat === lr.geo.lat)) {
           mixSegnalazioni.push({titolo: lr.titolo, descrizione: lr.descrizione, categoria: lr.categoria, lat: lr.geo.lat, lng: lr.geo.lng, dataStr: lr.when});
        }
      });

      mixSegnalazioni.forEach(r => {
        if(!r.lat) return;
        const info = catInfo[r.categoria] || catInfo.altro;
        const iconHtml = `<div style="background:rgba(10,16,32,.9); border:2px solid ${info.color}; border-radius:50%; width:36px; height:36px; display:flex; align-items:center; justify-content:center; font-size:18px; box-shadow:0 8px 20px rgba(0,0,0,0.6); backdrop-filter:blur(4px);">${info.emoji}</div>`;
        const icon = L.divIcon({ html: iconHtml, className: '', iconSize:[36,36], iconAnchor:[18,18], popupAnchor:[0,-18] });
        
        // POPUP con Tasto RAGGIUNGI
        const popupHtml = `
          <div style="min-width:200px; max-width:260px; max-height:240px; overflow-y:auto; padding-right:5px;">
            <b style="font-size:15px; display:block; margin-bottom:4px;">${info.emoji} ${r.titolo}</b>
            <small style="color:#a9b6db;">${r.dataStr || ''}</small>
            <p style="margin:10px 0; font-size:13px; line-height:1.5;">${r.descrizione || 'Nessuna descrizione.'}</p>
            <a class="btn primary small" href="https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}" target="_blank" style="text-decoration:none; display:flex; width:100%; padding:8px; margin-top:5px;">üß≠ Raggiungi</a>
          </div>`;
        
        if(layerMain) L.marker([r.lat, r.lng], {icon}).bindPopup(popupHtml).addTo(layerMain);
        if(layerHome) L.marker([r.lat, r.lng], {icon}).addTo(layerHome);
        bounds.push([r.lat, r.lng]);
      });

      // 2. Aggiungi Luoghi (Stelle)
      window.publicLuoghi.forEach(l => {
        if(!l.lat) return;
        const iconHtml = `<div style="background:#ff9f43; border:2px solid #fff; border-radius:8px; width:34px; height:34px; display:flex; align-items:center; justify-content:center; font-size:18px; box-shadow:0 8px 20px rgba(0,0,0,0.6);">‚≠ê</div>`;
        const icon = L.divIcon({ html: iconHtml, className: '', iconSize:[34,34], iconAnchor:[17,17], popupAnchor:[0,-17] });
        const stars = '‚≠ê'.repeat(l.rating || 5);
        
        // POPUP con Tasto RAGGIUNGI
        const popupHtml = `
          <div style="min-width:200px; max-width:260px; max-height:240px; overflow-y:auto; padding-right:5px;">
            <b style="font-size:15px; display:block; margin-bottom:4px;">${stars} ${l.nome}</b>
            <i style="color:#a9b6db; font-size:12px;">${l.categoria}</i>
            <p style="margin:10px 0; font-size:13px; line-height:1.5;">${l.recensione || ''}</p>
            <a class="btn primary small" href="https://www.google.com/maps/dir/?api=1&destination=${l.lat},${l.lng}" target="_blank" style="text-decoration:none; display:flex; width:100%; padding:8px; margin-top:5px;">üß≠ Raggiungi</a>
          </div>`;
        
        if(layerMain) L.marker([l.lat, l.lng], {icon}).bindPopup(popupHtml).addTo(layerMain);
        if(layerHome) L.marker([l.lat, l.lng], {icon}).addTo(layerHome);
        bounds.push([l.lat, l.lng]);
      });

      if(bounds.length && mapMain) mapMain.fitBounds(L.latLngBounds(bounds).pad(0.2));
    }

    function focusOnMap(lat, lng) {
      location.hash = "#/map";
      setTimeout(() => mapMain?.setView([lat, lng], 18), 300);
    }

    document.getElementById("btnMapFit")?.addEventListener("click", () => {
      refreshPublicMaps(); // Ricalcola i bounds e fa lo zoom out
    });

    // =========================
    // GESTIONE FOTO E DOCUMENTI
    // =========================
    
    document.getElementById("btnPickCamera").addEventListener("click", () => document.getElementById("fotoCamera").click());
    document.getElementById("btnPickGallery").addEventListener("click", () => document.getElementById("fotoGallery").click());
    document.getElementById("btnPickDocs").addEventListener("click", () => document.getElementById("docsInput").click());

    async function fileToDataUrl(file){
      return new Promise((resolve) => {
        const i = new Image(); i.onload = () => {
          const cvs = document.createElement("canvas");
          const r = Math.min(1, 1400 / Math.max(i.width, i.height));
          cvs.width = i.width*r; cvs.height = i.height*r;
          cvs.getContext("2d").drawImage(i, 0, 0, cvs.width, cvs.height);
          resolve(cvs.toDataURL("image/jpeg", 0.8));
        };
        i.src = URL.createObjectURL(file);
      });
    }

    async function handlePhotoUpload(e) {
      if(!e.target.files.length) return;
      for(const f of e.target.files) { 
        const d = await fileToDataUrl(f); 
        photos.push({ dataUrl: d, name: f.name, type: "image/jpeg" }); 
      }
      document.getElementById("photoPreview").style.display = "flex";
      document.getElementById("thumbs").innerHTML = photos.map(p => `<img src="${p.dataUrl}">`).join('');
    }
    document.getElementById("fotoGallery").addEventListener("change", handlePhotoUpload);
    document.getElementById("fotoCamera").addEventListener("change", handlePhotoUpload);

    document.getElementById("btnClearPhoto").addEventListener("click", () => { 
      photos = []; 
      document.getElementById("photoPreview").style.display = "none"; 
      document.getElementById("fotoGallery").value = "";
      document.getElementById("fotoCamera").value = "";
    });

    document.getElementById("docsInput").addEventListener("change", (e) => {
      if(!e.target.files.length) return;
      for(const f of e.target.files) {
        if(f.size > 6 * 1024 * 1024) { showBanner("error", "Documento troppo grande: " + f.name); continue; }
        const reader = new FileReader();
        reader.onload = (ev) => {
          documents.push({ dataUrl: ev.target.result, name: f.name, type: f.type });
          document.getElementById("docsPreview").style.display = "flex";
          document.getElementById("docsList").innerHTML = documents.map(d => `<div class="docItem" style="padding:8px; background:rgba(255,255,255,0.1); border-radius:12px; margin-top:5px;">üìÑ ${d.name}</div>`).join('');
        };
        reader.readAsDataURL(f);
      }
    });

    document.getElementById("btnClearDocs").addEventListener("click", () => {
      documents = [];
      document.getElementById("docsPreview").style.display = "none";
      document.getElementById("docsInput").value = "";
    });

    // =========================
    // FORM SEGNALAZIONE + GPS
    // =========================
    let geo = null; let geoWatchId = null; let geoLiveOn = false;
    let photos = []; let documents = []; 

    function renderGeo(){
      const geoLine = document.getElementById("geoLine");
      if(!geo){ geoLine.style.display = "none"; geoLine.textContent = ""; return; }
      geoLine.style.display = "block";
      geoLine.textContent = `üìç Posizione: ${geo.lat.toFixed(6)}, ${geo.lng.toFixed(6)}`;
    }

    document.getElementById("btnGeoOnce")?.addEventListener("click", () => {
      if(!navigator.geolocation) return showBanner("error", "GPS non supportato.");
      showBanner("info", "Recupero posizione‚Ä¶");
      navigator.geolocation.getCurrentPosition(
        (pos) => { geo = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy, mode: "gps" }; renderGeo(); showBanner("success", "Posizione acquisita."); },
        (err) => { showBanner("error", "Errore GPS."); }, { enableHighAccuracy: true, timeout: 10000 }
      );
    });

    document.getElementById("btnGeoClear")?.addEventListener("click", () => { geo = null; renderGeo(); showBanner("info", "Posizione rimossa."); });
    document.getElementById("anonimo").addEventListener("change", (e) => document.getElementById("contactBox").classList.toggle("hidden", e.target.checked));

    // INVIO SEGNALAZIONE (POST a /api/segnalazioni)
    document.getElementById("btnSend").addEventListener("click", async () => {
      const titolo = document.getElementById("titolo").value.trim(); 
      const descrizione = document.getElementById("descrizione").value.trim();
      if(titolo.length < 4 || descrizione.length < 10) return showBanner("error", "Compila bene Titolo e Descrizione.");
      
      const isAnon = document.getElementById("anonimo").checked;
      const payload = {
        titolo, descrizione, anonimo: isAnon, categoria: document.getElementById("categoria").value,
        when: new Date().toLocaleString("it-IT"), geo: geo,
        photos: photos, documents: documents, // Inviati in base64
        sender_contact: isAnon ? "Anonimo" : `üë§ ${document.getElementById("contactName").value} üìû ${document.getElementById("contactPhone").value} ‚úâÔ∏è ${document.getElementById("contactEmail").value}`
      };

      document.getElementById("btnSend").disabled = true;
      showBanner("info", "Invio in corso...");
      
      // Salva in locale
      const arr = loadReports(); arr.push({ id: String(Date.now()), ...payload, photoDataUrl: photos[0]?.dataUrl }); saveReports(arr);

      try{
        const res = await fetch(CONFIG.telegramWorkerUrl + "/api/segnalazioni", { method: "POST", headers: { "Content-Type": "application/json", "X-Api-Key": CONFIG.telegramApiKey }, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error();
        document.getElementById("titolo").value = ""; document.getElementById("descrizione").value = ""; photos=[]; geo=null;
        location.hash = "#/success"; fetchPublicData(); // Aggiorna i dati cloud
      }catch(e){
        showBanner("error", "Offline: Segnalazione salvata sul dispositivo."); location.hash = "#/my";
      }finally{ document.getElementById("btnSend").disabled = false; }
    });

    // =========================
    // FORM NUOVO LUOGO CON STELLINE
    // =========================
    let placeGeo = null; let placePhotos = [];
    document.getElementById("placePhotoInput").addEventListener("change", async (e) => {
      if(e.target.files.length) { 
        const d = await fileToDataUrl(e.target.files[0]); 
        placePhotos.push({dataUrl: d}); 
        document.getElementById("placePhotoPreview").innerHTML = `<img src="${d}" class="place-img-preview">`; 
      }
    });

    // INVIO LUOGO (POST a /api/luoghi)
    document.getElementById("btnSendPlace").addEventListener("click", async () => {
      const nome = document.getElementById("placeName").value.trim();
      if(!nome || !placeGeo) return showBanner("error", "Nome e Posizione sono obbligatori!");

      const ratingInput = document.querySelector('input[name="rating"]:checked');
      const rating = ratingInput ? parseInt(ratingInput.value) : 5;

      const payload = {
        nome, categoria: document.getElementById("placeCategory").value, 
        recensione: document.getElementById("placeReview").value,
        geo: placeGeo, photos: placePhotos, when: new Date().toLocaleString("it-IT"),
        rating: rating
      };

      document.getElementById("btnSendPlace").disabled = true;
      try{
        const res = await fetch(CONFIG.telegramWorkerUrl + "/api/luoghi", { method: "POST", headers: { "Content-Type": "application/json", "X-Api-Key": CONFIG.telegramApiKey }, body: JSON.stringify(payload) });
        if(res.ok) { 
          showBanner("success", "Recensione pubblicata!"); 
          document.getElementById("placeName").value = ""; document.getElementById("placeReview").value = ""; placeGeo = null; placePhotos = []; document.getElementById("placePhotoPreview").innerHTML = ""; document.getElementById("placeGeoLine").textContent="";
          setTimeout(() => { fetchPublicData(); location.hash = "#/places"; }, 1000);
        } else throw new Error();
      }catch(e){ showBanner("error", "Errore di connessione."); }
      finally{ document.getElementById("btnSendPlace").disabled = false; }
    });

    // =========================
    // MAP PICKER MODAL (Condiviso)
    // =========================
    let mapPicker = null, picked = null, pickedMarker = null, activePickerTarget = null;

    function openMapPicker(target){
      activePickerTarget = target;
      document.getElementById("mapPickerOverlay").style.display = "flex";
      if(!mapPicker){
        mapPicker = L.map("mapPicker").setView([41.492, 13.831], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(mapPicker);
        mapPicker.on("click", (e) => {
          picked = { lat: e.latlng.lat, lng: e.latlng.lng };
          document.getElementById("pickedLine").textContent = `Punto selezionato: ${picked.lat.toFixed(6)}, ${picked.lng.toFixed(6)}`;
          if(pickedMarker) pickedMarker.remove();
          pickedMarker = L.marker([picked.lat, picked.lng]).addTo(mapPicker);
        });
      }
      setTimeout(() => mapPicker.invalidateSize(), 100);
    }

    document.getElementById("btnGeoPick")?.addEventListener("click", () => openMapPicker("report"));
    document.getElementById("btnPlaceGeoPick")?.addEventListener("click", () => openMapPicker("place"));
    document.getElementById("mapPickerClose")?.addEventListener("click", () => document.getElementById("mapPickerOverlay").style.display="none");
    document.getElementById("btnCenterCassino")?.addEventListener("click", () => mapPicker?.setView([41.492, 13.831], 13));

    document.getElementById("btnUsePicked")?.addEventListener("click", () => {
      if(!picked) return showBanner("error", "Seleziona un punto sulla mappa.");
      if(activePickerTarget === "report") { geo = { ...picked, mode: "pick" }; renderGeo(); }
      if(activePickerTarget === "place") { placeGeo = { ...picked }; document.getElementById("placeGeoLine").textContent = `üìç Posizione: ${placeGeo.lat.toFixed(5)}, ${placeGeo.lng.toFixed(5)}`; }
      document.getElementById("mapPickerOverlay").style.display="none";
    });

    // =========================
    // STORICO LOCALE (My Reports)
    // =========================
    function renderList(){
      const arr = loadReports();
      const listEl = document.getElementById("list");
      document.getElementById("emptyState").style.display = arr.length ? "none" : "block";
      listEl.innerHTML = arr.slice().reverse().map(r => `
        <div class="item cat-${r.categoria || 'altro'}">
          <div style="display:flex; justify-content:space-between;">
            <span class="pill">${r.categoria || 'Altro'}</span><span class="hint">${r.when}</span>
          </div>
          <h3 style="margin:8px 0">${r.titolo}</h3><p style="margin:0 0 10px">${r.descrizione}</p>
          ${(r.photos && r.photos.length) ? `<div class="gallery-grid">${r.photos.map(p=>`<img src="${p.dataUrl}" class="gallery-img" onclick="window.open('${p.dataUrl}')">`).join('')}</div>` : (r.photoDataUrl ? `<div class="gallery-grid"><img src="${r.photoDataUrl}" class="gallery-img"></div>` : '')}
          ${r.geo ? `<button class="btn ghost small" style="margin-top:10px" onclick="focusOnMap(${r.geo.lat}, ${r.geo.lng})">üó∫Ô∏è Vedi in mappa</button>` : ''}
        </div>
      `).join('');
    }

    document.getElementById("btnClearAll")?.addEventListener("click", () => {
      if(!confirm("Cancellare tutto il tuo archivio locale?")) return;
      saveReports([]); renderList(); refreshPublicMaps();
    });

    // =========================
    // INIZIALIZZAZIONE
    // =========================
    function applyContacts(){
      const body = "Ciao,%0D%0A%0D%0AScrivo da SegnalaFacile:%0D%0A";
      document.getElementById("mailLink").href = `mailto:${CONFIG.email}?subject=Messaggio&body=${body}`;
      document.getElementById("mapLink").href = `https://www.google.com/maps?q=${encodeURIComponent(CONFIG.mapsQuery)}`;
    }

    initStorage().then(() => {
      applyContacts();
      ensureMaps();
      fetchPublicData();
      route();
    });
  </script>
</body>
</html>
