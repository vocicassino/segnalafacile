<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0b1220" />
  <title>Pannello Amministratore</title>
  
  <link rel="manifest" href="admin.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    body { font-family: system-ui, sans-serif; background: #0b1220; color: #eaf0ff; margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    .card { background: #162440; padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
    h1, h2 { margin-top: 0; }
    
    input[type="text"], input[type="password"], input[type="number"], select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #2d7dff; background: #070c18; color: white; margin-bottom: 15px; box-sizing: border-box; }
    textarea { min-height: 100px; resize: vertical; }
    button { cursor: pointer; background: #2d7dff; color: white; border: none; padding: 10px 16px; border-radius: 8px; font-weight: bold; font-size: 14px; margin-right: 5px; }
    button:hover { filter: brightness(1.2); }
    .btn-danger { background: #ff4d4f; }
    .btn-success { background: #19c37d; }
    
    .list-item { background: #070c18; padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .details { flex-grow: 1; margin-right: 15px; min-width: 250px; }
    .details h3 { margin: 0 0 5px 0; font-size: 16px; color: #19c37d; }
    .details p { margin: 0; font-size: 13px; color: #a9b6db; }
    .badge { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-right: 5px; }
    #dashboard { display: none; }

    /* SEZIONI ESPANDIBILI */
    .section-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding-bottom: 5px; }
    .section-header h2 { margin: 0; font-size: 20px; }
    .section-icon { font-size: 14px; transition: transform 0.3s ease; opacity: 0.8; }
    .section-content { margin-top: 15px; display: none; } 

    /* STILI PER I FILTRI DELLE CATEGORIE */
    .filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
    .filter-btn { background: rgba(255,255,255,0.08); color: #a9b6db; border: 1px solid rgba(255,255,255,0.15); padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: normal; margin: 0; transition: 0.2s ease; }
    .filter-btn:hover { background: rgba(255,255,255,0.15); }
    .filter-btn.active { background: #2d7dff; color: #ffffff; border-color: #2d7dff; font-weight: bold; box-shadow: 0 4px 10px rgba(45,125,255,0.3); }

    /* BOTTONE INSTALLA (Nascosto di default, gestito da JS) */
    #installAdminPill { display: none; background: #19c37d; margin-bottom: 20px; width: 100%; font-size: 16px; padding: 14px; border-radius: 12px; box-shadow: 0 4px 10px rgba(25,195,125,0.3); }

    /* MODAL PER LA MODIFICA */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; padding: 20px; z-index: 1000; }
    .modal { background: #162440; padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); width: 100%; max-width: 500px; box-sizing: border-box; }
    .modal h3 { margin-top: 0; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-size: 12px; color: #a9b6db; margin-bottom: 5px; }
  </style>
</head>
<body>

<div class="container">
  
  <button id="installAdminPill" type="button">‚¨áÔ∏è Installa Pannello Admin sul Telefono</button>

  <div class="card" id="loginBox">
    <h1>Area Amministratore üîí</h1>
    <p style="color: #a9b6db;">Inserisci la Password (API Key) per gestire il database.</p>
    <input type="password" id="apiKeyInput" placeholder="Inserisci Password..." />
    <button onclick="login()">Accedi al Database</button>
  </div>

  <div id="dashboard">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
      <h1 style="margin:0;">Gestione Database</h1>
      <button onclick="loadData()">üîÑ Aggiorna Dati</button>
    </div>

    <div class="card">
      <div class="section-header" onclick="toggleSection('luoghiSection', 'luoghiIcon')">
        <h2>Luoghi e Recensioni ‚≠ê</h2>
        <span id="luoghiIcon" class="section-icon">‚ñº</span>
      </div>
      <div id="luoghiSection" class="section-content">
        <div id="luoghiFilters" class="filters"></div>
        <div id="luoghiList">Caricamento...</div>
      </div>
    </div>

    <div class="card">
      <div class="section-header" onclick="toggleSection('segnalazioniSection', 'segnalazioniIcon')">
        <h2>Segnalazioni Utenti üìç</h2>
        <span id="segnalazioniIcon" class="section-icon">‚ñº</span>
      </div>
      <div id="segnalazioniSection" class="section-content">
        <div id="segnalazioniFilters" class="filters"></div>
        <div id="segnalazioniList">Caricamento...</div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="editModalOverlay">
  <div class="modal">
    <h3 id="modalTitle">Modifica</h3>
    
    <div class="form-group">
      <label id="labelTitoloNome">Titolo / Nome</label>
      <input type="text" id="editTitolo" />
    </div>

    <div class="form-group">
      <label>Categoria</label>
      <input type="text" id="editCategoria" placeholder="es. ristorante, rifiuti..." />
    </div>

    <div class="form-group" id="ratingGroup" style="display:none;">
      <label>Stelle (da 1 a 5)</label>
      <input type="number" id="editRating" min="1" max="5" />
    </div>

    <div class="form-group">
      <label id="labelDescrizione">Descrizione / Recensione</label>
      <textarea id="editDescrizione"></textarea>
    </div>

    <div style="display:flex; justify-content:space-between; margin-top:20px;">
      <button onclick="closeModal()" style="background:transparent; border:1px solid white;">Annulla</button>
      <button class="btn-success" onclick="saveEdit()">üíæ Salva Modifiche</button>
    </div>
  </div>
</div>

<script>
  // =========================
  // LOGICA INSTALLAZIONE INTELLIGENTE PWA
  // =========================
  const installBtn = document.getElementById("installAdminPill");
  let deferredPrompt = null;
  
  // Controllo se l'app √® gi√† installata (Standalone mode)
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

  if (!isStandalone) {
    // 1. Logica per Android / Chrome / Edge
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault(); 
      deferredPrompt = e;
      installBtn.style.display = "block"; // Mostra il bottone
      
      installBtn.addEventListener("click", async () => {
        if(deferredPrompt) {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          installBtn.style.display = "none";
        }
      }, { once: true });
    });

    // 2. Logica di Fallback per dispositivi iOS (iPhone/iPad)
    if (isIOS) {
      installBtn.style.display = "block"; // Su iOS lo mostriamo sempre
      installBtn.addEventListener("click", () => {
        alert(
          "Istruzioni per installare l'Admin su iPhone/iPad:\n\n" +
          "1Ô∏è‚É£ Tocca l'icona 'Condividi' in basso (il quadrato con la freccia verso l'alto).\n" +
          "2Ô∏è‚É£ Scorri in basso e seleziona 'Aggiungi alla schermata Home'."
        );
      });
    }
  }

  // =========================
  // LOGICA PANNELLO ADMIN
  // =========================
  const WORKER_URL = "https://segnalafacile-telegram.vocidicassino.workers.dev";
  let apiKey = "";
  let allData = { luoghi: [], segnalazioni: [] };
  
  let filterLuoghi = "Tutte";
  let filterSegnalazioni = "Tutte";

  let editingId = null;
  let editingType = null;

  // Funzione per Aprire/Chiudere le Sezioni
  function toggleSection(sectionId, iconId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById(iconId);
    if (section.style.display === "block") {
      section.style.display = "none";
      icon.style.transform = "rotate(0deg)";
    } else {
      section.style.display = "block";
      icon.style.transform = "rotate(180deg)";
    }
  }

  function login() {
    const input = document.getElementById("apiKeyInput").value.trim();
    if (!input) return alert("Inserisci la password.");
    apiKey = input;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
    
    // Apri automaticamente la prima sezione per far capire come funziona
    document.getElementById("luoghiSection").style.display = "block";
    document.getElementById("luoghiIcon").style.transform = "rotate(180deg)";

    loadData();
  }

  async function loadData() {
    document.getElementById("luoghiList").innerHTML = "Caricamento...";
    document.getElementById("segnalazioniList").innerHTML = "Caricamento...";
    
    try {
      const res = await fetch(WORKER_URL + "/api/public-data");
      const data = await res.json();
      
      if (!data.ok) throw new Error("Errore caricamento dati");
      
      allData.luoghi = data.luoghi || [];
      allData.segnalazioni = data.segnalazioni || [];

      renderFilters("luoghi");
      renderFilters("segnalazioni");
      updateListView("luoghi");
      updateListView("segnalazioni");

    } catch (e) {
      alert("Errore di connessione al database.");
    }
  }

  function renderFilters(type) {
    const items = allData[type];
    const container = document.getElementById(type + "Filters");
    const categoriePresenti = items.map(i => i.categoria ? i.categoria.trim() : "Altro");
    const categorieUniche = ["Tutte", ...new Set(categoriePresenti)];

    const currentFilter = type === "luoghi" ? filterLuoghi : filterSegnalazioni;

    container.innerHTML = categorieUniche.map(cat => {
      const activeClass = (cat === currentFilter) ? "active" : "";
      return `<button class="filter-btn ${activeClass}" onclick="setFilter('${type}', '${cat.replace(/'/g, "\\'")}')">${cat}</button>`;
    }).join('');
  }

  function setFilter(type, category) {
    if (type === "luoghi") filterLuoghi = category;
    else filterSegnalazioni = category;
    
    renderFilters(type);
    updateListView(type);
  }

  function updateListView(type) {
    let items = allData[type];
    const currentFilter = type === "luoghi" ? filterLuoghi : filterSegnalazioni;

    if (currentFilter !== "Tutte") {
      items = items.filter(i => (i.categoria ? i.categoria.trim() : "Altro") === currentFilter);
    }

    if (type === "luoghi") {
      renderListHTML("luoghiList", items, "luoghi", l => `
        <div class="details">
          <h3>‚≠ê ${l.nome} (${l.rating || 5} stelle)</h3>
          <p><span class="badge">${l.categoria}</span> ${l.recensione || 'Senza testo'}</p>
        </div>
      `);
    } else {
      renderListHTML("segnalazioniList", items, "segnalazioni", s => `
        <div class="details">
          <h3>üìç ${s.titolo}</h3>
          <p><span class="badge">${s.categoria}</span> ${s.dataStr}</p>
          <p style="margin-top:4px;">${s.descrizione || 'Senza descrizione'}</p>
        </div>
      `);
    }
  }

  function renderListHTML(containerId, items, type, formatHtml) {
    const container = document.getElementById(containerId);
    if (!items || items.length === 0) {
      container.innerHTML = "<p style='color:#a9b6db;'>Nessun elemento in questa categoria.</p>";
      return;
    }

    container.innerHTML = items.map(item => `
      <div class="list-item" id="item-${item.id}">
        ${formatHtml(item)}
        <div style="display:flex; gap:5px;">
          <button onclick="openEditModal('${item.id}', '${type}')">‚úèÔ∏è Modifica</button>
          <button class="btn-danger" onclick="deleteItem('${item.id}', '${type}')">üóëÔ∏è Cancella</button>
        </div>
      </div>
    `).join('');
  }

  async function deleteItem(id, type) {
    if (!confirm("Sei sicuro di voler eliminare questo elemento?")) return;
    try {
      const res = await fetch(`${WORKER_URL}/api/${type}/${id}`, {
        method: "DELETE",
        headers: { "X-Api-Key": apiKey }
      });
      const result = await res.json();
      if (result.ok) {
        allData[type] = allData[type].filter(i => i.id !== id);
        renderFilters(type);
        updateListView(type);
      } else {
        alert("Errore: " + (result.error || "Non Autorizzato"));
      }
    } catch (e) { alert("Errore di rete."); }
  }

  function openEditModal(id, type) {
    editingId = id;
    editingType = type;
    
    const item = allData[type].find(x => x.id === id);
    if(!item) return;

    if(type === 'segnalazioni') {
      document.getElementById("modalTitle").innerText = "Modifica Segnalazione";
      document.getElementById("labelTitoloNome").innerText = "Titolo";
      document.getElementById("labelDescrizione").innerText = "Descrizione";
      document.getElementById("ratingGroup").style.display = "none";

      document.getElementById("editTitolo").value = item.titolo || "";
      document.getElementById("editCategoria").value = item.categoria || "";
      document.getElementById("editDescrizione").value = item.descrizione || "";
    } else {
      document.getElementById("modalTitle").innerText = "Modifica Luogo";
      document.getElementById("labelTitoloNome").innerText = "Nome del Luogo";
      document.getElementById("labelDescrizione").innerText = "Recensione";
      document.getElementById("ratingGroup").style.display = "block";

      document.getElementById("editTitolo").value = item.nome || "";
      document.getElementById("editCategoria").value = item.categoria || "";
      document.getElementById("editRating").value = item.rating || 5;
      document.getElementById("editDescrizione").value = item.recensione || "";
    }

    document.getElementById("editModalOverlay").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("editModalOverlay").style.display = "none";
    editingId = null;
    editingType = null;
  }

  async function saveEdit() {
    const payload = {};
    if(editingType === 'segnalazioni') {
      payload.titolo = document.getElementById("editTitolo").value.trim();
      payload.categoria = document.getElementById("editCategoria").value.trim();
      payload.descrizione = document.getElementById("editDescrizione").value.trim();
    } else {
      payload.nome = document.getElementById("editTitolo").value.trim();
      payload.categoria = document.getElementById("editCategoria").value.trim();
      payload.recensione = document.getElementById("editDescrizione").value.trim();
      payload.rating = parseInt(document.getElementById("editRating").value) || 5;
    }

    try {
      const res = await fetch(`${WORKER_URL}/api/${editingType}/${editingId}`, {
        method: "PUT",
        headers: { "X-Api-Key": apiKey, "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      
      if (result.ok) {
        closeModal();
        loadData(); 
      } else {
        alert("Errore: " + (result.error || "Non Autorizzato"));
      }
    } catch (e) { alert("Errore di rete durante il salvataggio."); }
  }
</script>
</body>
</html>
